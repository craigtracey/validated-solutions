<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="last modified" content="27/09/2021 12:47:24"><meta name=abstract content><meta name=author content="dpavel@vmware.com"><meta name=primary-product-name content="MD2Docs-TestBed"><meta name=primary-product-version content="1"><meta name=description content><meta name=guid content="GUID-1Intro"><meta name=language content="en"><meta name=title content="Basic Markdown"><meta name=publication-author content="dpavel@vmware.com"><meta property="og:title" content="Basic Markdown"><meta property="og:image" content="https://docs-uat.vmware.com/uicontent/images/vmware-docs-default.png"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html"><meta name=cdf-utag content="https://tags.tiqcdn.com/utag/vmware/cdf-privacy/qa/utag.js"><link rel=stylesheet type=text/css href=/validated-solutions/css/commonltr.css><link rel=stylesheet type=text/css href=/validated-solutions/css/non-draft.vmware.productdocs.css><link rel=canonical href=https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html><link class=user href=/validated-solutions/css/responsive.css rel=stylesheet type=text/css><link rel=icon href=https://www.vmware.com/favicon.ico type=image/x-icon><link rel=stylesheet href=/validated-solutions/css/v2-global.20200911172508.css><title>Docs Preview</title></head><body><header class=tech-pub-header><div id=header class="global-header col-12"><div class="row desktop-header h-100"><div class="col col-md-3 align-self-center header-logo-wrapper"><div class="d-inline-flex align-items-center justify-content-start w-100"><div class="d-inline-flex align-items-center w-100"><span class="my-auto d-md-none header-menu-icon"><i class="fa fa-bars"></i></span><h1><a href=https://docs-uat-staging.vmware.com/ class="d-inline-flex align-items-center my-auto nav-link header-logo-url pl-md-1 pl-xl-3"><span class=mr-2><img src=/validated-solutions/img/vm-logo.png alt="VMware Logo"></span>
<span class=vm-logo-title>Docs Preview</span></a></h1></div><div class=align-items-center><span id=toggleTOC class="d-md-none header-toc-icon"><i class="fa fa-ellipsis-v px-2"></i></span></div></div></div></div></div><div class="col-12 vmware-gradient w-100 px-0 mx-0"></div></header><div class="tech-pub-container main-container d-flex flex-column pubView"><section class="tech-pub-section d-flex flex-md-row"><div class="lhs lhs-container col-md-4 col-lg-3" style=display:block><div class=backdrop></div><div class=left-panel><div class="panel-header position-relative hidden-xs"><div class="panel-header-left d-flex justify-content-between align-items-center"><span class=container-collapse-expand><span id=expand-all-id class=expand-tree onclick=expandAll()><span class="lhs-expand-shape align-middle"><i class="fa fa-chevron-down"></i></span>
<span class="expand-text align-middle" data-i18n data-i18n-expand-all>Expand All</span></span>
<span id=collapse-all-id class="collapse-tree hide" onclick=collapseAll()><span class="lhs-collapse-shape align-middle"><i class="fa fa-chevron-up"></i></span>
<span class="collapse-text align-middle" data-i18n data-i18n-collapse-all>Collapse All</span></span></span></div></div><div class="panel-content p-2" id=left_toc><div class="dropdown collection-dropdown-container w-100"><button class="btn w-100 text-left dropdown-toggle collection-name" type=button id=collectionDropdwnBtn data-toggle=dropdown aria-haspopup=true aria-label="Collection Dropdown" aria-expanded=false>
<span class=label></span>
<span class="float-right icon-down pl-2 fa fa-angle-down"></span></button><div class="dropdown-menu w-100" id=collectionMenu aria-labelledby=collectionDropdwnBtn></div></div><div id=tree class=mt-2></div><div class="w-100 px-2 toc-product-container"><a class="mr-3 my-2 position-relative toc-product-link"><span class=toc-product-name></span>
<span class=localized-page-name>Product Documentation</span></a></div><ul class=rm-default-ul-styles></ul></div></div></div><div class="rhs rhs-container col-md-8 col-lg-7" style=display:block><div class=rhs-top><div class="rhs-top-container-top d-flex flex-row justify-content-between"><h1 class=primary-header id=prepare-external-identity-management>Prepare External Identity Management</h1></div><div class="rhs-top-container-middle d-flex flex-row justify-content-between"></div><div class=rhs-top-container-bottom><div class=last-updated-container><div class=calendar-icon><svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path class="clr-i-outline clr-i-outline-path-1" d="M32.25 6H29V8h3V30H4V8H7V6H3.75A1.78 1.78.0 002 7.81V30.19A1.78 1.78.0 003.75 32h28.5A1.78 1.78.0 0034 30.19V7.81A1.78 1.78.0 0032.25 6z"/><rect class="clr-i-outline clr-i-outline-path-2" x="8" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-3" x="14" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-4" x="20" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-5" x="26" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-6" x="8" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-7" x="14" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-8" x="20" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-9" x="26" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-10" x="8" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-11" x="14" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-12" x="20" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-13" x="26" y="24" width="2" height="2"/><path class="clr-i-outline clr-i-outline-path-14" d="M10 10a1 1 0 001-1V3A1 1 0 009 3V9a1 1 0 001 1z"/><path class="clr-i-outline clr-i-outline-path-15" d="M26 10a1 1 0 001-1V3a1 1 0 00-2 0V9a1 1 0 001 1z"/><rect class="clr-i-outline clr-i-outline-path-16" x="13" y="6" width="10" height="2"/><rect x="0" y="0" width="36" height="36" fill-opacity="0"/></svg></div><span class=last-updated-label data-i18n-updated-on>Updated on</span>
&nbsp;
<span class=last-updated-date-ph>9/22/22</span></div></div></div><div class="rhs-center article-wrapper" id=content-div-id><h1 id=prepare-external-identity-management>Prepare External Identity Management</h1><p>Tanzu Kubernetes Grid implements user authentication with Pinniped. Pinniped allows you to plug external OpenID Connect (OIDC) or LDAP identity providers (IDP) into Tanzu Kubernetes clusters, so that you can control user access to those clusters.</p><p>You can enable identity management during or after management cluster deployment. Any workload clusters that you create after enabling identity management are automatically configured to use the same identity provider as the management cluster.</p><ul><li><p>Enabling and configuring identity management during management cluster deployment (Recommended):</p><ul><li>Obtain your identity provider details.</li><li>Use the obtained details to configure LDAPS or OIDC in Tanzu Kubernetes Grid.</li><li>After the management cluster has been created, confirm that the authentication service is running correctly and complete its configuration.</li></ul></li><li><p>Enabling and configuring identity management after management cluster deployment:</p><ul><li>Obtain your identity provider details.</li><li>Generate the Pinniped add-on secret for the management cluster.</li><li>Confirm that the authentication service is running correctly and complete its configuration.</li><li>If the management cluster manages any workload clusters, generate the Pinniped add-on secret for each workload cluster that was created before you enabled identity management.</li></ul></li></ul><h2 id=enable-and-configure-identity-management-during-management-cluster-deployment>Enable and Configure Identity Management During Management Cluster Deployment</h2><p>This section explains how to enable and configure identity management during management cluster deployment.</p><h3 id=obtain-your-identity-provider-details>Obtain Your Identity Provider Details</h3><p>Before you can enable identity management, you must have an identity provider. Tanzu Kubernetes Grid supports LDAPS and OIDC identity providers.</p><p>To use your company’s internal LDAPS server as the identity provider, obtain LDAPS information from your LDAP administrator.</p><p>To use OIDC as the identity provider, you must have an account with an identity provider that supports the OpenID Connect standard, for example, <a href=https://www.okta.com/>Okta</a>.</p><p>For more information on using Okta as your OIDC provider, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-id-mgmt.html#obtain-your-identity-provider-details-3>Register a Tanzu Kubernetes Grid Application in Okta</a>.</p><h3 id=configure-ldaps-or-oidc-settings-in-tanzu-kubernetes-grid>Configure LDAPS or OIDC Settings in Tanzu Kubernetes Grid</h3><p>When you are deploying your management cluster using the installer interface, configure LDAPS or OIDC in the Identity Management section. For instructions, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-deploy-ui.html#id-mgmt>Configure Identity Management</a> in Deploy Management Clusters with the Installer Interface.</p><ol><li><p>In the <strong>Identity Management</strong> section of the management cluster deployment UI,</p><ol><li>Enable <strong>Enable Identity Management Settings</strong>.</li><li>Select the provider as <strong>OIDC</strong> or <strong>LDAPS</strong>.</li></ol><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-1.png alt="Enable identity management and specify the provider"></p></li><li><p>If you choose to use <strong>OIDC</strong>, provide details of your OIDC provider account, for example, Okta.</p><ul><li><p><strong>Issuer URL</strong>: The IP or DNS address of your OIDC server.</p></li><li><p><strong>Client ID</strong>: The client_id value that you obtain from your OIDC provider. For example, if your provider is Okta, log in to Okta, create a Web application, and select the <strong>Client Credentials</strong> options in order to get a <strong>client_id</strong> and <strong>secret</strong>.</p></li><li><p><strong>Client Secret</strong>: The secret value that you obtain from your OIDC provider.</p></li><li><p><strong>Scopes</strong>: A comma separated list of additional scopes to request in the token response. For example, <strong>openid</strong>,<strong>groups</strong>,<strong>email</strong>.</p></li><li><p><strong>Username Claim</strong>: The name of your username claim. This is used to set a user’s username in the JSON Web Token (JWT) claim. Depending on your provider, enter claims such as <strong>user_name</strong>, <strong>email</strong>, or <strong>code</strong>.</p></li><li><p><strong>Groups Claim</strong>: The name of your groups claim. This is used to set a user’s group in the JWT claim. For example, <strong>groups</strong>.</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-2.png alt="Identity management settings for OIDC"></p></li></ul></li><li><p>If you choose to use <strong>LDAPS</strong>, provide details of your company’s LDAPS server. All settings except for LDAPS Endpoint are optional.</p><ul><li><p><strong>LDAPS Endpoint</strong>: The IP or DNS address of your LDAPS server. Provide the address and port of the LDAP server, in the form host:port.</p></li><li><p><strong>Bind DN</strong>: The DN for an application service account. The connector uses these credentials to search for users and groups. Not required if the LDAP server provides access for anonymous authentication.</p></li><li><p><strong>Bind Password</strong>: The password for an application service account, if Bind DN is set.</p></li><li><p><strong>Base DN</strong>: The point from which to start the LDAP search. For example, OU=Users,OU=domain,DC=io.</p></li><li><p><strong>Filter</strong>: An optional filter to be used by the LDAP search.</p></li><li><p><strong>Username</strong>: The LDAP attribute that contains the user ID. For example, uid, sAMAccountName.</p></li><li><p><strong>Base DN</strong>: The point from which to start the LDAP search. For example, OU=Groups,OU=domain,DC=io.</p></li><li><p><strong>Filter</strong>: An optional filter to be used by the LDAP search.</p></li><li><p><strong>Name Attribute</strong>: The LDAP attribute that holds the name of the group. For example, cn.</p></li><li><p><strong>User Attribute</strong>: The attribute of the user record that is used as the value of the membership attribute of the group record. For example, distinguishedName, dn.</p></li><li><p><strong>Group Attribute</strong>: The attribute of the group record that holds the user/member information. For example, member.</p></li><li><p>Paste the contents of the LDAPS server CA certificate into the Root CA text box.</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-3.png alt="Identity management settings for LDAPS"></p></li><li><p>(Optional) Verify the LDAP settings.</p><ul><li>Click <strong>Verify LDAP Configuration</strong>.</li><li>Enter a user name and group name.</li><li>Click <strong>Start</strong>. After verification completes, if you see any failures, examine them closely.</li></ul></li></ul></li><li><p>Click <strong>Next</strong> and proceed with management cluster creation.</p></li><li><p>After you deploy the management cluster, proceed with <a href=#complete-the-identity-management-configuration-on-management-cluster>Complete the configuration of Identity Management in the Management Cluster</a></p></li></ol><h2 id=enable-and-configure-identity-management-in-an-existing-deployment>Enable and Configure Identity Management in an Existing Deployment</h2><p>If you did not configure identity management when you deployed your management cluster, you can enable it as a post-deployment step by doing the following:</p><ol><li><p><a href=#obtain-your-identity-provider-details>Obtain your identity provider details</a>.</p></li><li><p><a href=#generate-the-pinniped-add-on-secret-for-the-management-cluster-and-deploy-pinniped-package>Generate a Kubernetes secret for the Pinniped add-on and deploy Pinniped package.</a></p></li><li><p><a href=#complete-the-identity-management-configuration-on-management-cluster>Complete the identity management configuration on the management cluster</a>.</p></li><li><p><a href=#configure-rbac>Create role bindings for your management cluster users.</a></p></li><li><p><a href=#enable-identity-management-on-workload-clusters>Enable identity management in workload clusters.</a></p></li></ol><h3 id=obtain-your-identity-provider-details-1>Obtain your identity provider details</h3><p>Before you can identity management, you must have an identity provider. Tanzu Kubernetes Grid supports LDAPS and OIDC identity providers.</p><p>To use your company’s internal LDAPS server as the identity provider, obtain LDAPS information from your LDAP administrator.</p><p>To use OIDC as the identity provider, you must have an account with an identity provider that supports the OpenID Connect standard, for example, <a href=https://www.okta.com/>Okta</a>.</p><p>For more information on using Okta as your OIDC provider, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-id-mgmt.html#obtain-your-identity-provider-details-3>Register a Tanzu Kubernetes Grid Application in Okta</a>.</p><p>For more information on obtaining your identity provider details, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-id-mgmt.html#idp>Obtain Your Identity Provider Details</a>.</p><h3 id=generate-the-pinniped-add-on-secret-for-the-management-cluster-and-deploy-pinniped-package>Generate the Pinniped Add-on Secret for the Management Cluster and deploy Pinniped package</h3><p>This procedure configures the Pinniped add-on and deploys the authentication components in your management cluster. To generate a Kubernetes secret for the Pinniped add-on:</p><ol><li><p>Set the context of kubectl to your management cluster. For example, with a management cluster named id-mgmt-test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl config use-context tkg-mgmt-01-admin@tkg-mgmt-01</span>
</span></span><span style=display:flex><span>Switched to context <span style=color:#e6db74>&#34;tkg-mgmt-01-admin@tkg-mgmt-01&#34;</span>
</span></span></code></pre></div></li><li><p>Create a cluster configuration file by copying the configuration settings that you defined when you deployed your management cluster into a new file. In addition to the variables from the original management cluster configuration, include the following OIDC or LDAP identity provider details in the file:</p><p><strong>Note</strong>: With the exception of IDENTITY_MANAGEMENT_TYPE, you need to set these variables only for management clusters. For workload clusters, set IDENTITY_MANAGEMENT_TYPE to the same value as in the management cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Identity management type. This must be &#34;oidc&#34; or &#34;ldap&#34;.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>IDENTITY_MANAGEMENT_TYPE</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set these variables if you want to configure OIDC.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>CERT_DURATION</span>: <span style=color:#ae81ff>2160h</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CERT_RENEW_BEFORE</span>: <span style=color:#ae81ff>360h</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_CLIENT_ID</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_CLIENT_SECRET</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_GROUPS_CLAIM</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_ISSUER_URL</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_SCOPES</span>: <span style=color:#e6db74>&#34;email,profile,groups&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OIDC_IDENTITY_PROVIDER_USERNAME_CLAIM</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set these variables if you want to configure LDAP.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_BIND_DN</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_BIND_PASSWORD</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_BASE_DN</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_FILTER</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_GROUP_ATTRIBUTE</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_NAME_ATTRIBUTE</span>: <span style=color:#ae81ff>cn</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_USER_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_HOST</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_ROOT_CA_DATA_B64</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_BASE_DN</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_EMAIL_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_FILTER</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_ID_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_NAME_ATTRIBUTE</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_USERNAME</span>: <span style=color:#ae81ff>userPrincipalName</span>
</span></span></code></pre></div></li><li><p>Providing a sample management cluster configuration file below after updating the ldap configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#! ---------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#! vSphere non proxy env configs</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#! ---------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_CA_DATA_B64</span>: <span style=color:#ae81ff>&lt;base64-encoded-cert&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_CLOUD_NAME</span>: <span style=color:#ae81ff>tkgvsphere-cloud01</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_CONTROLLER</span>: <span style=color:#ae81ff>alb-ctlr01.lab.vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_DATA_NETWORK</span>: <span style=color:#ae81ff>tkg-mgmt-vip-segment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_DATA_NETWORK_CIDR</span>: <span style=color:#ae81ff>172.16.50.0</span><span style=color:#ae81ff>/24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_ENABLE</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_LABELS</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   </span>   <span style=color:#f92672>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;management&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_PASSWORD</span>: <span style=color:#ae81ff>&lt;encoded:Vk13YXJlMSE=&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_SERVICE_ENGINE_GROUP</span>: <span style=color:#ae81ff>tkgvsphere-tkgmgmt-group01</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_USERNAME</span>: <span style=color:#ae81ff>admin</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CLUSTER_CIDR</span>: <span style=color:#ae81ff>100.96.0.0</span><span style=color:#ae81ff>/11</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CLUSTER_NAME</span>: <span style=color:#ae81ff>tkg-mgmt-01</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CLUSTER_PLAN</span>: <span style=color:#ae81ff>prod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_CEIP_PARTICIPATION</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_MHC</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#----------Providing the ldap config here---------------------</span>
</span></span><span style=display:flex><span><span style=color:#f92672>IDENTITY_MANAGEMENT_TYPE</span>: <span style=color:#ae81ff>ldap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_BIND_DN</span>: <span style=color:#ae81ff>cn=administrator,cn=Users,dc=lab,dc=vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_BIND_PASSWORD</span>: <span style=color:#ae81ff>VMware1!</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_BASE_DN</span>: <span style=color:#ae81ff>cn=Users,dc=lab,dc=vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_FILTER</span>: <span style=color:#ae81ff>(objectClass=group)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_GROUP_ATTRIBUTE</span>: <span style=color:#ae81ff>member</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_NAME_ATTRIBUTE</span>: <span style=color:#ae81ff>member</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_GROUP_SEARCH_USER_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_HOST</span>: <span style=color:#ae81ff>dns.lab.vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_ROOT_CA_DATA_B64</span>: <span style=color:#ae81ff>&lt;base64-encoded-cert&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_BASE_DN</span>: <span style=color:#ae81ff>cn=Users,dc=lab,dc=vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_EMAIL_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_FILTER</span>: <span style=color:#ae81ff>(objectClass=person)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_ID_ATTRIBUTE</span>: <span style=color:#ae81ff>DN</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_NAME_ATTRIBUTE</span>: <span style=color:#ae81ff>userPrincipalName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>LDAP_USER_SEARCH_USERNAME</span>: <span style=color:#ae81ff>userPrincipalName</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#f92672>INFRASTRUCTURE_PROVIDER</span>: <span style=color:#ae81ff>vsphere</span>
</span></span><span style=display:flex><span><span style=color:#f92672>SERVICE_CIDR</span>: <span style=color:#ae81ff>100.64.0.0</span><span style=color:#ae81ff>/13</span>
</span></span><span style=display:flex><span><span style=color:#f92672>TKG_HTTP_PROXY_ENABLED</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>DEPLOY_TKG_ON_VSPHERE7</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_DATACENTER</span>: <span style=color:#ae81ff>/tkgm-internet-dc1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_DATASTORE</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/datastore/vsanDatastore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_FOLDER</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/vm/tkg-vsphere-tkg-mgmt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_NETWORK</span>: <span style=color:#ae81ff>pg-tkg_mgmt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_PASSWORD</span>: <span style=color:#ae81ff>&lt;encoded:Vk13YXJlMSE=&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_RESOURCE_POOL</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/host/tkgm-internet-c1/Resources/tkg-vsphere-tkg-Mgmt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_SERVER</span>: <span style=color:#ae81ff>vcenter.lab.vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_SSH_AUTHORIZED_KEY</span>: <span style=color:#ae81ff>&lt;vcenter-ssh-key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_USERNAME</span>: <span style=color:#ae81ff>administrator@vsphere.local</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_INSECURE</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_CONTROL_PLANE_HA_PROVIDER</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_AUDIT_LOGGING</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_ARCH</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_NAME</span>: <span style=color:#ae81ff>photon</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_VERSION</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_NAME</span>: <span style=color:#ae81ff>pg-tkg-cluster-vip</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_CIDR</span>: <span style=color:#ae81ff>172.16.80.0</span><span style=color:#ae81ff>/24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>WORKER_SIZE</span>: <span style=color:#ae81ff>medium</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CONTROLPLANE_SIZE</span>: <span style=color:#ae81ff>medium</span>
</span></span></code></pre></div></li><li><p>Make sure your local environment has IDENTITY_MANAGEMENT_TYPE set to either <code>oidc</code> or <code>ldap</code>, and not <code>none</code>:</p><pre tabindex=0><code># export IDENTITY_MANAGEMENT_TYPE=ldap

# echo $IDENTITY_MANAGEMENT_TYPE
ldap
</code></pre></li><li><p>Set the _TKG_CLUSTER_FORCE_ROLE environment variable to management:</p><pre tabindex=0><code>export _TKG_CLUSTER_FORCE_ROLE=&#34;management&#34;
</code></pre></li><li><p>Set the FILTER_BY_ADDON_TYPE environment variable to authentication/pinniped:</p><pre tabindex=0><code>export FILTER_BY_ADDON_TYPE=&#34;authentication/pinniped&#34;
</code></pre></li><li><p>Generate a secret for the Pinniped add-on:</p><pre tabindex=0><code>tanzu cluster create CLUSTER-NAME --dry-run -f CLUSTER-CONFIG-FILE &gt; CLUSTER-NAME-example-secret.yaml

Example:
# tanzu cluster create tkg-mgmt-01 --dry-run -f tkg-mgmt-01.yaml &gt; tkg-mgmt-01-example-secret.yaml

# ls
tkg-mgmt-01.yaml 	       tkg-mgmt-01-example-secret.yaml
</code></pre><p>The environment variable settings cause tanzu cluster create &ndash;dry-run to generate a Kubernetes secret, not a full cluster manifest.</p><p><strong>Note</strong>: This command generates the manifest with default namespace, however you need to create the secret in tkg-system namespace for kapp controller to reconcile the core addon. So manually edit the file and change the namespace to “tkg-system”</p></li><li><p>Review the secret and then apply it to the management cluster. For example:</p><pre tabindex=0><code># kubectl apply -f tkg-mgmt-01-example-secret.yaml
secret/tkg-mgmt-01-pinniped-addon created
</code></pre></li><li><p>After applying the secret, check the status of the Pinniped add-on by running the kubectl get app command:</p><pre tabindex=0><code># kubectl get app pinniped -n tkg-system
NAME         DESCRIPTION                  SINCE-DEPLOY   AGE
pinniped   Reconcile succeeded      92s                          4m3s
</code></pre><p><strong>Note</strong>: If the Pinniped app reconcile fails, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-update-addons.html#troubleshooting>Troubleshooting Core Add-on Configuration</a>.</p></li></ol><h2 id=complete-the-identity-management-configuration-on-management-cluster>Complete the Identity Management Configuration on Management Cluster</h2><p>After deploying the management cluster, do the following to complete the identity management configuration:</p><ol><li>Connect kubectl to the management cluster.</li><li>Confirm that the authentication service is running correctly by checking its status:<ul><li><strong>OIDC</strong>: Check the Status of an OIDC Identity Management Service.</li><li><strong>LDAP</strong>: Check the Status of an LDAP Identity Management Service.</li><li><strong>OIDC</strong>: Provide the Callback URI to the OIDC Provider.</li></ul></li><li>If you want to use regular, non-administrator <code>kubeconfig</code> files for access to the management cluster, after completing the configuration of identity management, configure RBAC by following the instructions in <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-rbac.html#rbac-mgmt>Configure RBAC for a Management Cluster</a>.</li></ol><h2 id=connect-kubectl-to-the-management-cluster>Connect kubectl to the Management Cluster</h2><p>To configure identity management, you must obtain and use the admin context of the management cluster:</p><ol><li><p>Get the admin context of the management cluster. The procedures in this topic use a management cluster named tkg-mgmt.</p><pre tabindex=0><code>$ tanzu management-cluster `kubeconfig` get tkg-mgmt --admin

Credentials of cluster &#39;tkg-mgmt&#39; have been saved
You can now access the cluster by running &#39;kubectl config use-context tkg-mgmt-admin@tkg-mgmt&#39;
</code></pre><p>The admin context of a cluster gives you full access to the cluster without requiring authentication with your IDP</p></li><li><p>Set kubectl to the admin context of the management cluster:</p><pre tabindex=0><code>$ kubectl config use-context tkg-mgmt@tkg-mgmt 
Switched to context &#34;tkg-mgmt-admin@tkg-mgmt&#34;.
</code></pre></li></ol><h2 id=check-the-status-of-an-ldap-identity-management-service>Check the Status of an LDAP Identity Management Service</h2><p>Tanzu Kubernetes Grid uses Pinniped to integrate clusters with an LDAP identity service, along with Dex to expose the service endpoint. When you enable LDAP, Tanzu Kubernetes Grid creates the <code>pinniped-supervisor</code> service in the <code>pinniped-supervisor</code> namespace, <code>pinniped-concierge</code> in the <code>pinniped-concierge</code> namespace, and <code>dexsvc</code> in the <code>tanzu-system-auth</code> namespace.</p><p>Follow the steps below to check the status of an LDAP service and note the EXTERNAL-IP address at which the service is exposed.</p><ol><li><p>Verify that the Pinniped package was installed and reconciled successfully.</p><pre tabindex=0><code># kubectl get app pinniped -n tkg-system

NAMESPACE	NAME                            	DESCRIPTION       	SINCE-DEPLOY   AGE
tkg-system   pinniped                        	Reconcile succeeded   3m44s      	49m
</code></pre></li><li><p>Get information about the pinniped supervisor and <code>dexsvc</code> services that are running in the management cluster.</p><pre tabindex=0><code># kubectl get svc -n pinniped-supervisor
pinniped-supervisor                 pinniped-supervisor                               LoadBalancer   100.67.31.28    192.168.51.4   443:31088/TCP            17d


# kubectl get svc -n tanzu-system-auth
NAME               	TYPE                     CLUSTER-IP    EXTERNAL-IP    PORT(S)      	AGE
dexsvc               LoadBalancer   100.65.110.223   192.168.51.5         443:31769/TCP   8h
</code></pre></li><li><p>Proceed with generating the <code>kubeconfig</code> and creating the role based access control. For more information, see <a href=#configure-rbac>Configure RBAC</a>.</p></li></ol><h2 id=check-the-status-of-an-oidc-identity-management-service>Check the Status of an OIDC Identity Management Service</h2><p>Tanzu Kubernetes Grid uses Pinniped to integrate clusters with an OIDC identity service. When you enable OIDC, Tanzu Kubernetes Grid creates the pinniped-supervisor service in the pinniped-supervisor namespace and pinniped-concierge in the pinniped-concierge namespace.</p><p>Follow the steps below to check the status of the Pinniped service and note the EXTERNAL-IP address at which the service is exposed.</p><ol><li><p>Verify that the Pinniped package was installed and reconciled successfully.</p><pre tabindex=0><code># kubectl get apps pinniped -n tkg-system

NAMESPACE	NAME                            	DESCRIPTION       	SINCE-DEPLOY   AGE
tkg-system   pinniped                        	Reconcile succeeded   3m44s      	49m
</code></pre></li><li><p>Get information about the services that are running in the management cluster. The identity management service runs in the pinniped-supervisor namespace.</p><pre tabindex=0><code># kubectl get svc -n pinniped-supervisor
NAME                	TYPE                     CLUSTER-IP    EXTERNAL-IP PORT(S)     	AGE
pinniped-supervisor   LoadBalancer   100.65.110.223   192.168.51.4   443:31769/TCP   8h
</code></pre></li><li><p>Note the external address of the pinniped-supervisor service, as listed under EXTERNAL-IP.</p></li><li><p>Update the External IP in the login redirect URI in the OIDC identity provider. For more information, see <a href=#provide-the-callback-uri-to-the-oidc-provider-oidc-only>Provide the Callback URI to the OIDC Provider</a>.</p></li><li><p>Once you update the redirect URI, proceed with generating the <code>kubeconfig</code> and creating the role based access control. For more information, see <a href=#configure-rbac>Configure RBAC</a>.</p></li></ol><h2 id=provide-the-callback-uri-to-the-oidc-provider-oidc-only>Provide the Callback URI to the OIDC Provider (OIDC Only)</h2><p>If you configured the management cluster to use OIDC authentication, you must provide the callback URI for that management cluster to your OIDC identity provider.</p><ol><li><p>Log in to your Okta account.</p></li><li><p>In the main menu, go to <strong>Applications</strong>.</p></li><li><p>Select the application that you created for Tanzu Kubernetes Grid.</p></li><li><p>In the General Settings panel, click <strong>Edit</strong>.</p></li><li><p>Under Login, update <strong>Login redirect URIs</strong> to include the address of the node in which the pinniped-supervisor is running.</p></li><li><p>Add the external IP address of the node at which the pinniped-supervisor service is running, that you noted in the previous procedure.</p><p><strong>Note</strong>: You must specify https, not http.</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-4.png alt="Specify callback URI for management cluster to OIDC identity provider"></p></li></ol><h2 id=enable-identity-management-on-workload-clusters>Enable Identity Management on Workload Clusters</h2><p>Any workload clusters that you create after you enable identity management in the management cluster are automatically configured to use the same identity management service. You can proceed with generating a <code>kubeconfig</code> file and share it with users for connecting to the cluster. For more information on generating <code>kubeconfig</code> and creating the role based access, see <a href=#configure-rbac>Configure RBAC</a>.</p><p>If a workload cluster was created before you enabled identity management for your management cluster, you must enable it manually. To enable identity management for a workload cluster:</p><ol><li><p>Generate the Pinniped add-on secret:</p><ul><li><p>Create a cluster configuration file by copying the configuration settings that you defined when you deployed your workload cluster into a new file. In addition to the variables from the original cluster configuration, include the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Identity management type used by the management cluster. This must be &#34;oidc&#34; or &#34;ldap&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>IDENTITY_MANAGEMENT_TYPE</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This is the Pinniped supervisor service endpoint in the management cluster.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>SUPERVISOR_ISSUER_URL</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Pinniped uses this b64-encoded CA bundle data for communication between the management cluster and the workload cluster.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>SUPERVISOR_ISSUER_CA_BUNDLE_DATA_B64</span>:
</span></span></code></pre></div></li></ul></li><li><p>You can retrieve SUPERVISOR_ISSUER_URL and SUPERVISOR_ISSUER_CA_BUNDLE_DATA_B64 by running <code>kubectl get configmap pinniped-info -n kube-public -o yaml</code> against the management cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># kubectl get configmap pinniped-info -n kube-public -o yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>cluster_name</span>: <span style=color:#ae81ff>tkg-mgmt-01</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>concierge_is_cluster_scoped</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>issuer</span>: <span style=color:#ae81ff>https://172.16.80.104</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>issuer_ca_bundle_data</span>: <span style=color:#ae81ff>&lt;base64-issuer-ca&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>creationTimestamp</span>: <span style=color:#e6db74>&#34;2022-03-24T12:03:46Z&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pinniped-info</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kube-public</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>resourceVersion</span>: <span style=color:#e6db74>&#34;62756&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>uid</span>: <span style=color:#ae81ff>7f399d41-ab1b-41f2-9cd1-1d5fc4ddf9e1</span>
</span></span></code></pre></div></li><li><p>Create the cluster configuration by providing above details. Here is a sample workload config file with ldap configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>CLUSTER_CIDR</span>: <span style=color:#ae81ff>100.96.0.0</span><span style=color:#ae81ff>/11</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CLUSTER_NAME</span>: <span style=color:#ae81ff>workload-2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CLUSTER_PLAN</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_CEIP_PARTICIPATION</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_MHC</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>IDENTITY_MANAGEMENT_TYPE</span>: <span style=color:#ae81ff>none</span>
</span></span><span style=display:flex><span><span style=color:#f92672>INFRASTRUCTURE_PROVIDER</span>: <span style=color:#ae81ff>vsphere</span>
</span></span><span style=display:flex><span><span style=color:#f92672>SERVICE_CIDR</span>: <span style=color:#ae81ff>100.64.0.0</span><span style=color:#ae81ff>/13</span>
</span></span><span style=display:flex><span><span style=color:#f92672>TKG_HTTP_PROXY_ENABLED</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>DEPLOY_TKG_ON_VSPHERE7</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_DATACENTER</span>: <span style=color:#ae81ff>/tkgm-internet-dc1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_DATASTORE</span>: <span style=color:#ae81ff>vsanDatastore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_FOLDER</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/vm/tkg-vsphere-workload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_NETWORK</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/network/pg-tkg_workload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_PASSWORD</span>: <span style=color:#ae81ff>&lt;encoded:Vk13YXJlMSE=&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_RESOURCE_POOL</span>: <span style=color:#ae81ff>/tkgm-internet-dc1/host/tkgm-internet-c1/Resources/tkg-vsphere-workload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_SERVER</span>: <span style=color:#ae81ff>vcenter.lab.vmw</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_SSH_AUTHORIZED_KEY</span>: <span style=color:#ae81ff>&lt;vsphere-ssh-key&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_USERNAME</span>: <span style=color:#ae81ff>administrator@vsphere.local</span>
</span></span><span style=display:flex><span><span style=color:#f92672>WORKER_MACHINE_COUNT</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>VSPHERE_INSECURE</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_AUDIT_LOGGING</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_DEFAULT_STORAGE_CLASS</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ENABLE_AUTOSCALER</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AVI_CONTROL_PLANE_HA_PROVIDER</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_ARCH</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_NAME</span>: <span style=color:#ae81ff>photon</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OS_VERSION</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>WORKER_SIZE</span>: <span style=color:#ae81ff>medium</span>
</span></span><span style=display:flex><span><span style=color:#f92672>CONTROLPLANE_SIZE</span>: <span style=color:#ae81ff>medium</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>IDENTITY_MANAGEMENT_TYPE</span>: <span style=color:#ae81ff>ldap</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>SUPERVISOR_ISSUER_URL</span>: <span style=color:#ae81ff>https://172.16.80.104</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>SUPERVISOR_ISSUER_CA_BUNDLE_DATA_B64</span>: <span style=color:#ae81ff>&lt;Supervisor issuer CA from previous step&gt;</span>
</span></span></code></pre></div></li><li><p>Ensure that the local environment variable IDENTITY_MANAGEMENT_TYPE set to either oidc or ldap:</p><pre tabindex=0><code># export IDENTITY_MANAGEMENT_TYPE=ldap

# echo $IDENTITY_MANAGEMENT_TYPE
ldap
</code></pre></li><li><p>Set the _TKG_CLUSTER_FORCE_ROLE environment variable to workload:</p><pre tabindex=0><code>export _TKG_CLUSTER_FORCE_ROLE=&#34;workload&#34;
</code></pre></li><li><p>Set the FILTER_BY_ADDON_TYPE environment variable to authentication/pinniped:</p><pre tabindex=0><code>export FILTER_BY_ADDON_TYPE=&#34;authentication/pinniped&#34;
</code></pre></li><li><p>Generate a secret for the Pinniped add-on:</p><pre tabindex=0><code>tanzu cluster create workload-2 --dry-run -f workload-2.yaml &gt; workload-2-example-secret.yaml

# ls
Workload-2.yaml       workload-2-example-secret.yaml
</code></pre><p>The environment variable settings cause tanzu cluster create &ndash;dry-run to generate a Kubernetes secret, not a full cluster manifest.</p></li><li><p>Review the secret and apply it to the management cluster. The Pinniped add-on secret is always created or applied to the management cluster, even if you are configuring a workload cluster.</p><ul><li><p>Set the context of kubectl to the management cluster. For example, with a management cluster named tkg-mgmt:</p><pre tabindex=0><code># kubectl config use-context tkg-mgmt-01-admin@tkg-mgmt-01
Switched to context &#34;tkg-mgmt-01-admin@tkg-mgmt-01&#34;
</code></pre></li><li><p>Apply the secret.</p><pre tabindex=0><code># kubectl apply -f workload-2-example-secret.yaml
secret/workload-2-pinniped-addon created
</code></pre></li></ul></li><li><p>After applying the secret, check the status of the Pinniped add-on:</p><ul><li>Set the context of kubectl to your workload cluster:</li></ul><pre tabindex=0><code># kubectl config use-context workload-2-admin@workload-2
Switched to context &#34;workload-2-admin@workload-2&#34;.
</code></pre><ul><li>Run the kubectl get app command against the workload cluster:</li></ul><pre tabindex=0><code># kubectl get app pinniped -n tkg-system

NAME        DESCRIPTION             SINCE-DEPLOY   AGE
pinniped   Reconcile succeeded      53s            2m43s
</code></pre></li><li><p>If you plan to use regular, non-administrator <code>kubeconfig</code> files for cluster access, proceed with generating the <code>kubeconfig</code> and creating the role based access control. For more information, see <a href=#configure-rbac>Configure RBAC</a>.</p></li></ol><h2 id=configure-rbac>Configure RBAC</h2><p>To give users access to a management or a workload cluster, you generate a <code>kubeconfig</code> file and then share the file with those users. If you provide them with the administrator <code>kubeconfig</code> for the cluster, they have full access to the cluster and do not need to be authenticated. However, if you provide users with the regular <code>kubeconfig</code>, they must have a user account in your OIDC or LDAP identity provider and you must configure RBAC on the cluster to grant access permissions to the designated user.</p><p>For more information on how to configure role-based access control (RBAC) in Tanzu Kubernetes Grid, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-rbac.html#rbac-mgmt>Configure RBAC</a>.</p><h3 id=generate-and-test-a-non-administrator-kubeconfig-file-for-the-tanzu-clusters>Generate and Test a Non-Administrator <code>kubeconfig</code> File for the Tanzu Clusters</h3><p>This procedure allows you to test the login step of the authentication process if a browser is present on the machine on which you are running tanzu and kubectl commands. If the machine does not have a browser, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-iam-configure-id-mgmt.html#no-browser>Authenticate Users on a Machine Without a Browser</a>.</p><ol><li><p>Export the regular <code>kubeconfig</code> for the management cluster to a local file, for example, /tmp/id_mgmt_test_kubeconfig. Note that the command does not include the &ndash;admin option, so the <code>kubeconfig</code> that is exported is the regular <code>kubeconfig</code>, not the admin version.</p><pre tabindex=0><code># tanzu management-cluster `kubeconfig` get tkg-mgmt --export-file /tmp/id_mgmt_test_kubeconfig
You can now access the cluster by specifying &#39;--kubeconfig /tmp/id_mgmt_test_kubeconfig flag when using `kubectl` command
</code></pre></li><li><p>Connect to the management cluster by using the newly created <code>kubeconfig</code> file:</p><pre tabindex=0><code># kubectl get pods -A --kubeconfig /tmp/id_mgmt_test_kubeconfig
</code></pre><p>The authentication process requires a browser to be present on the machine from which users connect to clusters because running kubectl commands automatically opens the IdP login page so that users can log in to the cluster. Your browser should open and display the login page for your OIDC provider or an LDAPS login page.</p><p><strong>LDAPS</strong>:</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-5.png alt="LDAPS login page"></p><p><strong>OIDC</strong>:</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-6.png alt="OIDC provider login page"></p><p>Enter the credentials of a user account that exists in your OIDC or LDAP server. After a successful login, the browser should display the following.
<img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-7.png alt="Login confirmation message"></p></li><li><p>Go back to the terminal in which you run tanzu and kubectl commands:</p><ul><li><p>If you already configured a role binding on the cluster for the authenticated user, the output of <code>kubectl get pods -A</code> appears, displaying the pod information.</p></li><li><p>If you have not configured a role binding on the cluster, you see a message denying the user account access to the pods:</p><pre tabindex=0><code>Error from server (Forbidden): pods is forbidden: User &#34;user@example.com&#34; cannot list resource &#34;pods&#34; in API group &#34;&#34; at the cluster scope. 
</code></pre></li></ul><p>This happens because the user has been successfully authenticated, but they are not yet authorized to access any resources on the cluster. To authorize the user to access the cluster resources, you must Create a Role Binding on the Management Cluster as described in <a href=#create-a-role-binding-on-the-management-cluster>Create a Role Binding on the Management Cluster</a>.</p></li></ol><h3 id=create-a-role-binding-on-the-management-cluster>Create a Role Binding on the Management Cluster</h3><p>To give non-admin users access to a management cluster, you generate and distribute a <code>kubeconfig</code> file as described in <a href=#generate-and-test-a-non-administrator-kubeconfig-file-for-the-management-cluster>Generate and Test a Non-Administrator <code>kubeconfig</code> File for the Management Cluster</a>.</p><p>To make the <code>kubeconfig</code> work, you must first set up RBAC by creating a role binding on the management cluster. This role binding assigns role-based permissions to individual authenticated users or user groups. There are many roles with which you can associate users, but the most useful roles are the following:</p><ul><li><strong>cluster-admin</strong>: Can perform any operation on the cluster.</li><li><strong>admin</strong>: Permission to view most resources but can only modify resources like roles and bindings. Cannot modify pods or deployments.</li><li><strong>edit</strong>: The opposite of admin. Can create, update, and delete resources like deployments, services, and pods. Cannot change roles or permissions.</li><li><strong>view</strong>: Read-only.</li></ul><p>You can assign any of the roles to users. For more information about custom roles and role bindings, see <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Using RBAC Authorization</a> in the Kubernetes documentation.</p><ol><li><p>Make sure that you are using the admin context of the management cluster:</p><pre tabindex=0><code>kubectl config current-context
</code></pre></li><li><p>If the context is not the management cluster admin context, set kubectl to use that context. For example:</p><pre tabindex=0><code>kubectl config use-context tkg-mgmt-admin@tkg-mgmt
</code></pre></li><li><p>List your existing roles:</p><ul><li><p>To see the full list of namespace-scoped roles, run:</p><pre tabindex=0><code>kubectl get roles --all-namespaces
</code></pre></li><li><p>To see the full list of cluster-scoped roles, run:</p><pre tabindex=0><code>kubectl get clusterroles
</code></pre></li></ul></li><li><p>To associate a given user with a role, create a role binding.</p><ul><li>A RoleBinding can reference a Role or ClusterRole.</li><li>A ClusterRoleBinding can reference only a ClusterRole.</li></ul></li><li><p>The following example creates a cluster role binding named id-mgmt-test-rb that binds the cluster role cluster-admin to the user <a href=mailto:user@example.com>user@example.com</a>:</p><pre tabindex=0><code>kubectl create clusterrolebinding tkg-mgmt-rb --clusterrole cluster-admin --user user@example.com
</code></pre><p>For &ndash;user, specify the OIDC or LDAP username of the user. You configured the username attribute and other identity provider details in the Identity Management section of the Tanzu Kubernetes Grid installer interface or by setting the <strong>LDAP_*</strong> or <strong>OIDC_*</strong> variables:</p><ol><li><p><strong>OIDC</strong>: The username attribute is set in the <strong>Username Claim</strong> field under <strong>OIDC Identity Management Source</strong> in the installer interface or the OIDC_IDENTITY_PROVIDER_USERNAME_CLAIM configuration variable.</p></li><li><p><strong>LDAPS</strong>: The username attribute is set in the <strong>Username</strong> field under <strong>LDAPS Identity Management Source –> User Search Attributes</strong> in the installer interface or the LDAP_USER_SEARCH_USERNAME configuration variable.</p><p>For example, for OIDC, the username is often the email address of the user. For LDAPS, it is the LDAP username, not the email address.</p></li><li><p>Attempt to connect to the management cluster again by using the <code>kubeconfig</code> file that you created in the previous procedure:</p><pre tabindex=0><code>kubectl get pods -A --kubeconfig /tmp/id_mgmt_test_kubeconfig
</code></pre></li></ol></li></ol><p>This time, because the user is bound to the cluster-admin role on this management cluster, the list of pods should be displayed. You can share the generated <code>kubeconfig</code> file with any users for whom you configure role bindings on the management cluster.</p><h2 id=authenticate-users-on-a-machine-without-a-browser>Authenticate Users on a Machine Without a Browser</h2><p>If your bootstrap machine is a jumpbox or other machine with no display, you can authenticate to a cluster from a browser running on your local machine. How you do this depends on the cluster’s Pinniped version, which comes from the Tanzu Kubernetes release that the cluster is based on.</p><p>For clusters based on older TKrs or created by older versions of Tanzu Kubernetes Grid : Follow the <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-cluster-lifecycle-connect.html#no-browser>Authenticate Users on a Machine Without a Browser</a> procedure in the Tanzu Kubernetes Grid v1.4 documentation.</p><p>For clusters based on TKr v1.22.5 (default for Tanzu Kubernetes Grid v1.5) or later, do the following:</p><ol><li><p>From a terminal window on your local machine, run ssh to remotely log in to your bootstrap machine.</p></li><li><p>Set the TANZU_CLI_PINNIPED_AUTH_LOGIN_SKIP_BROWSER=true environment variable. This adds the &ndash;skip-browser option to the <code>kubeconfig</code> for the cluster.</p><pre tabindex=0><code>export TANZU_CLI_PINNIPED_AUTH_LOGIN_SKIP_BROWSER=true
</code></pre></li><li><p>Export the regular <code>kubeconfig</code> for the cluster to a local file. Note that the command does not include the &ndash;admin option, so the <code>kubeconfig</code> that is exported is the regular <code>kubeconfig</code>, not the admin version.</p><pre tabindex=0><code>## For a management cluster, run:

# tanzu management-cluster `kubeconfig` get tkg-mgmt --export-file /tmp/mgmt-kubeconfig
You can now access the cluster by specifying &#39;--kubeconfig /tmp/mgmt-kubeconfig&#39; flag when using `kubectl` command

## For a workload cluster, run:

# tanzu cluster `kubeconfig` get workload-2 --export-file /tmp/workload-kubeconfig
You can now access the cluster by specifying &#39;--kubeconfig /tmp/workload-kubeconfig&#39; flag when using `kubectl` command
</code></pre></li><li><p>Connect to the cluster by using the newly-created <code>kubeconfig</code> file. The CLI outputs a login link for your identity provider.</p><pre tabindex=0><code># kubectl get pods -A --kubeconfig /tmp/mgmt-kubeconfig
Log in by visiting this link:
https://172.16.80.104/oauth2/authorize?access_type=offline&amp;client_id=pinniped-cli&amp;code_challenge=Was7DEO7GQL4tSOrQ9qH4D31stBngVkLgVcwS6SYFQg&amp;code_challenge_method=S256&amp;nonce=b4a1d3cc079c803387f4ad87b91e551d&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A41723%2Fcallback&amp;response_mode=form_post&amp;response_type=code&amp;scope=offline_access+openid+pinniped%3Arequest-audience&amp;state=266ffa2a3852bf523609d625f98b0588

   Optionally, paste your authorization code:
</code></pre></li><li><p>Copy the link and paste it into a browser on your local machine and log in to your identity provider.</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-8.png alt="LDAPS login page"></p></li><li><p>A page appears prompting you to paste an authorization code into the CLI to finish you login:</p><p><img src=/img/deployment-guides/pinniped-with-tkg/01-pinniped-9.png alt="Authorization code prompt"></p></li><li><p>Copy the authorization code and paste it into the CLI, after the Optionally, paste your authorization code: prompt.</p></li><li><p>Connect to the cluster again by using the same <code>kubeconfig</code> file as you used previously:</p><pre tabindex=0><code># kubectl get pods -A --kubeconfig /tmp/mgmt-kubeconfig
Error from server (Forbidden): pods is forbidden: User &#34;tanzu-user1@lab.vmw&#34; cannot list resource &#34;pods&#34; in API group &#34;&#34; at the cluster scope
</code></pre></li><li><p>If you already configured a role binding on the cluster for the authenticated user, the output shows the pod information.</p></li><li><p>If you have not configured a role binding on the cluster, you will see a message denying the user account access to the pods: Error from server (Forbidden): pods is forbidden: User &ldquo;<a href=mailto:user@example.com>user@example.com</a>&rdquo; cannot list resource &ldquo;pods&rdquo; in API group "" at the cluster scope. This happens because the user has been successfully authenticated, but they are not yet authorized to access any resources on the cluster.</p></li><li><p>To authorize the user to access the cluster resources, you must configure RBAC on the cluster by creating a cluster role binding. For more information, see <a href=#configure-rbac>Configure RBAC</a>.</p></li></ol></div></div><div class="loader-container-toc col-lg-2 w-100" style=display:none><span class=spinner></span></div><div class="rhs-right-container d-none d-lg-block col-lg-2"><div class=rhs-right-panel><div class="rhs-right-panel-header d-flex justify-content-between"><div class=rhs-right-panel-title>In this article</div></div><div id=right-toc-div-id class="onpage-toc-container d-flex flex-column"><nav id=TableOfContents><ul><li><a href=#enable-and-configure-identity-management-during-management-cluster-deployment>Enable and Configure Identity Management During Management Cluster Deployment</a><ul><li><a href=#obtain-your-identity-provider-details>Obtain Your Identity Provider Details</a></li><li><a href=#configure-ldaps-or-oidc-settings-in-tanzu-kubernetes-grid>Configure LDAPS or OIDC Settings in Tanzu Kubernetes Grid</a></li></ul></li><li><a href=#enable-and-configure-identity-management-in-an-existing-deployment>Enable and Configure Identity Management in an Existing Deployment</a><ul><li><a href=#obtain-your-identity-provider-details-1>Obtain your identity provider details</a></li><li><a href=#generate-the-pinniped-add-on-secret-for-the-management-cluster-and-deploy-pinniped-package>Generate the Pinniped Add-on Secret for the Management Cluster and deploy Pinniped package</a></li></ul></li><li><a href=#complete-the-identity-management-configuration-on-management-cluster>Complete the Identity Management Configuration on Management Cluster</a></li><li><a href=#connect-kubectl-to-the-management-cluster>Connect kubectl to the Management Cluster</a></li><li><a href=#check-the-status-of-an-ldap-identity-management-service>Check the Status of an LDAP Identity Management Service</a></li><li><a href=#check-the-status-of-an-oidc-identity-management-service>Check the Status of an OIDC Identity Management Service</a></li><li><a href=#provide-the-callback-uri-to-the-oidc-provider-oidc-only>Provide the Callback URI to the OIDC Provider (OIDC Only)</a></li><li><a href=#enable-identity-management-on-workload-clusters>Enable Identity Management on Workload Clusters</a></li><li><a href=#configure-rbac>Configure RBAC</a><ul><li><a href=#generate-and-test-a-non-administrator-kubeconfig-file-for-the-tanzu-clusters>Generate and Test a Non-Administrator <code>kubeconfig</code> File for the Tanzu Clusters</a></li><li><a href=#create-a-role-binding-on-the-management-cluster>Create a Role Binding on the Management Cluster</a></li></ul></li><li><a href=#authenticate-users-on-a-machine-without-a-browser>Authenticate Users on a Machine Without a Browser</a></li></ul></nav></div></div></div></section></div><footer class=tech-pub-footer><div id=page-footer><section class="footer-component footer-container"><div class=personalization_div_1 style=min-height:1px></div><div class=personalization_div_2 style=min-height:1px></div><div class=container><div class=content><div class=row><div class="col-lg-12 col-md-12"><footer class=footer><div class=row><div class="col-lg-2 col-md-12 mb-40 mt-3"><a class=footer-vmware-logo href=https://www-lt.vmware.com/ name="nav_footer : VMware Logo"><picture class=float-lg-left><source media=(max-width:800px) srcset=https://www-lt.vmware.com/content/dam/digitalmarketing/vmware/vm-logo-big.png.imgo.jpeg><img loading=lazy class=vmware-logo src=/validated-solutions/img/vm-logo-big.png alt=VMware title=VMware></picture></a></div></div></footer></div></div></div></div></section></div></footer><script src=/validated-solutions/js/pageStore.js></script>
<script src=/validated-solutions/js/main.js></script></body></html>