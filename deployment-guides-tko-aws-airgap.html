<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="last modified" content="27/09/2021 12:47:24"><meta name=abstract content><meta name=author content="dpavel@vmware.com"><meta name=primary-product-name content="MD2Docs-TestBed"><meta name=primary-product-version content="1"><meta name=description content><meta name=guid content="GUID-1Intro"><meta name=language content="en"><meta name=title content="Basic Markdown"><meta name=publication-author content="dpavel@vmware.com"><meta property="og:title" content="Basic Markdown"><meta property="og:image" content="https://docs-uat.vmware.com/uicontent/images/vmware-docs-default.png"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html"><meta name=cdf-utag content="https://tags.tiqcdn.com/utag/vmware/cdf-privacy/qa/utag.js"><link rel=stylesheet type=text/css href=/validated-solutions/css/commonltr.css><link rel=stylesheet type=text/css href=/validated-solutions/css/non-draft.vmware.productdocs.css><link rel=canonical href=https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html><link class=user href=/validated-solutions/css/responsive.css rel=stylesheet type=text/css><link rel=icon href=https://www.vmware.com/favicon.ico type=image/x-icon><link rel=stylesheet href=/validated-solutions/css/v2-global.20200911172508.css><title>Docs Preview</title></head><body><header class=tech-pub-header><div id=header class="global-header col-12"><div class="row desktop-header h-100"><div class="col col-md-3 align-self-center header-logo-wrapper"><div class="d-inline-flex align-items-center justify-content-start w-100"><div class="d-inline-flex align-items-center w-100"><span class="my-auto d-md-none header-menu-icon"><i class="fa fa-bars"></i></span><h1><a href=https://docs-uat-staging.vmware.com/ class="d-inline-flex align-items-center my-auto nav-link header-logo-url pl-md-1 pl-xl-3"><span class=mr-2><img src=/validated-solutions/img/vm-logo.png alt="VMware Logo"></span>
<span class=vm-logo-title>Docs Preview</span></a></h1></div><div class=align-items-center><span id=toggleTOC class="d-md-none header-toc-icon"><i class="fa fa-ellipsis-v px-2"></i></span></div></div></div></div></div><div class="col-12 vmware-gradient w-100 px-0 mx-0"></div></header><div class="tech-pub-container main-container d-flex flex-column pubView"><section class="tech-pub-section d-flex flex-md-row"><div class="lhs lhs-container col-md-4 col-lg-3" style=display:block><div class=backdrop></div><div class=left-panel><div class="panel-header position-relative hidden-xs"><div class="panel-header-left d-flex justify-content-between align-items-center"><span class=container-collapse-expand><span id=expand-all-id class=expand-tree onclick=expandAll()><span class="lhs-expand-shape align-middle"><i class="fa fa-chevron-down"></i></span>
<span class="expand-text align-middle" data-i18n data-i18n-expand-all>Expand All</span></span>
<span id=collapse-all-id class="collapse-tree hide" onclick=collapseAll()><span class="lhs-collapse-shape align-middle"><i class="fa fa-chevron-up"></i></span>
<span class="collapse-text align-middle" data-i18n data-i18n-collapse-all>Collapse All</span></span></span></div></div><div class="panel-content p-2" id=left_toc><div class="dropdown collection-dropdown-container w-100"><button class="btn w-100 text-left dropdown-toggle collection-name" type=button id=collectionDropdwnBtn data-toggle=dropdown aria-haspopup=true aria-label="Collection Dropdown" aria-expanded=false>
<span class=label></span>
<span class="float-right icon-down pl-2 fa fa-angle-down"></span></button><div class="dropdown-menu w-100" id=collectionMenu aria-labelledby=collectionDropdwnBtn></div></div><div id=tree class=mt-2></div><div class="w-100 px-2 toc-product-container"><a class="mr-3 my-2 position-relative toc-product-link"><span class=toc-product-name></span>
<span class=localized-page-name>Product Documentation</span></a></div><ul class=rm-default-ul-styles></ul></div></div></div><div class="rhs rhs-container col-md-8 col-lg-7" style=display:block><div class=rhs-top><div class="rhs-top-container-top d-flex flex-row justify-content-between"><h1 class=primary-header id=deploy-tanzu-kubernetes-grid-on-aws-in-an-air-gapped-environment>Deploy Tanzu Kubernetes Grid on AWS in an Air-Gapped Environment</h1></div><div class="rhs-top-container-middle d-flex flex-row justify-content-between"></div><div class=rhs-top-container-bottom><div class=last-updated-container><div class=calendar-icon><svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path class="clr-i-outline clr-i-outline-path-1" d="M32.25 6H29V8h3V30H4V8H7V6H3.75A1.78 1.78.0 002 7.81V30.19A1.78 1.78.0 003.75 32h28.5A1.78 1.78.0 0034 30.19V7.81A1.78 1.78.0 0032.25 6z"/><rect class="clr-i-outline clr-i-outline-path-2" x="8" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-3" x="14" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-4" x="20" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-5" x="26" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-6" x="8" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-7" x="14" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-8" x="20" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-9" x="26" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-10" x="8" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-11" x="14" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-12" x="20" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-13" x="26" y="24" width="2" height="2"/><path class="clr-i-outline clr-i-outline-path-14" d="M10 10a1 1 0 001-1V3A1 1 0 009 3V9a1 1 0 001 1z"/><path class="clr-i-outline clr-i-outline-path-15" d="M26 10a1 1 0 001-1V3a1 1 0 00-2 0V9a1 1 0 001 1z"/><rect class="clr-i-outline clr-i-outline-path-16" x="13" y="6" width="10" height="2"/><rect x="0" y="0" width="36" height="36" fill-opacity="0"/></svg></div><span class=last-updated-label data-i18n-updated-on>Updated on</span>
&nbsp;
<span class=last-updated-date-ph>9/22/22</span></div></div></div><div class="rhs-center article-wrapper" id=content-div-id><h1 id=deploy-tanzu-kubernetes-grid-on-aws-in-an-air-gapped-environment>Deploy Tanzu Kubernetes Grid on AWS in an Air-Gapped Environment</h1><p>This document outlines the steps for deploying VMware Tanzu for Kubernetes Operations on AWS in an air-gapped (Internet-restricted) environment. The deployment is based on the reference design provided in <a href=../reference-designs/tko-on-aws-airgap.md>VMware Tanzu Kubernetes Grid on AWS Airgap Reference Design</a>.</p><h2 id=deploying-with-vmware-service-installer-for-tanzu>Deploying with VMware Service Installer for Tanzu</h2><p>You can use VMware Service Installer for VMware Tanzu to automate this deployment.</p><p>VMware Service Installer for Tanzu automates the deployment of the reference designs for Tanzu for Kubernetes Operations. It uses best practices for deploying and configuring the required Tanzu for Kubernetes Operations components.</p><p>To use Service Installer to automate this deployment, see <a href=https://docs.vmware.com/en/Service-Installer-for-VMware-Tanzu/1.3/service-installer/GUID-AWS%20-%20Federal%20Airgap-AWSFederalAirgap-DeploymentGuide.html>Deploying Tanzu Kubernetes Grid on Federal Air-gapped AWS VPC Using Service Installer for VMware Tanzu</a>.</p><p>Alternatively, if you decide to manually deploy each component, follow the steps provided in this document.</p><h2 id=prerequisites>Prerequisites</h2><p>Before deploying VMware Tanzu for Kubernetes Operations in an AWS air-gapped environment, ensure that the following are set up.</p><ul><li><p><strong>AWS Account</strong>: An IAM user account with <strong>administrative privileges</strong>.</p></li><li><p><strong>AWS Resource Quotas</strong>: Sufficient quotas to support both the management cluster and the workload clusters in your deployment. Otherwise, the cluster deployments will fail. Depending on the number of workload clusters you plan to deploy, you may need to increase the AWS services quotas from their default values. You will need to increase the quota in every region in which you deploy Tanzu Kubernetes Grid.
For more information, follow these links:</p><ul><li><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-aws.html#aws-resources>Tanzu Kubernetes Grid resources in AWS account</a>.</li><li><a href=https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html>AWS service quotas</a> in the AWS.</li></ul></li><li><p><strong>An Internet-connected Linux bootstrap machine</strong>
The bootstrap machine can be a local device such as a laptop or a virtual machine running in, for example, VMware Workstation or Fusion. You will use the bootstrap machine to create the AWS VPC and jumpbox. The bootstrap machine:</p><ul><li>Is not inside the Internet-restricted environment or is able to access the domains listed in Proxy Server Allowlist.</li><li>Has the Docker client app installed.</li><li>Has <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-install-cli.html>imgpkg</a> installed.</li><li>Has the latest version of yq installed.</li><li>Has the latest version of jq installed.</li><li>Has AWS CLI installed.</li><li>Has the <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-install-cli.html>Carvel Tools</a> installed, if you intend to install one or more of the optional packages provided by Tanzu Kubernetes Grid, such as Harbor.</li></ul></li><li><p><strong>VMware Cloud</strong>: Access to <a href=https://customerconnect.vmware.com/login>VMware Cloud</a> to download Tanzu CLI.</p></li></ul><p>For additional information about preparing to deploy Tanzu Kubernetes Grid on AWS, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-aws.html>Prepare to Deploy Management Clusters to Amazon EC2</a>.</p><h2 id=overview-of-the-deployment-steps>Overview of the Deployment Steps</h2><p>The main steps to deploy Tanzu for Kubernetes Operations on AWS EC2 are as follows. Each step links to more detailed instructions.</p><ol><li><a href=#aws-infra>Set up AWS Infrastructure</a>.</li><li><a href=#offline-jumpbox>Create an Offline JumpBox</a></li><li><a href=#private-repo>Create and Set Up a Private container registry</a>.</li><li><a href=#copy-tkg-img>Copy the container images required to deploy Tanzu Kubernetes Grid</a>.</li><li><a href=#prepEnv>Prepare an Internet-Restricted Environment</a>.</li><li><a href=#install-tkg>Install Tanzu Kubernetes Grid Management Cluster</a>.</li><li><a href=#examine-cluster>Examine the Management Cluster Deployment</a>.</li><li><a href=#deploy-workload-cluster>Deploy Workload Clusters</a>.</li><li><a href=#install-packages>Install and Configure Packages into Workload Clusters</a>.</li><li><a href=#logs>Logs and Troubleshooting</a>.</li><li><a href=#cluster-mgmt>Delete Clusters</a>.</li><li><a href=#stig-fips>Air-Gapped STIG/FIPS Deployment on AWS</a>.</li><li><a href=#upgrade-tkg>Tanzu Kubernetes Grid Upgrade</a>.</li></ol><h2 id=a-idaws-infra-a-set-up-aws-infrastructure>Set up AWS Infrastructure</h2><p>The following describes the steps to create your AWS environment and configure your network. Follow the steps in the order provided.</p><h3 id=create-an-internet-restricted-virtual-private-cloud-vpc>Create an Internet-Restricted Virtual Private Cloud (VPC)</h3><p>Follow these steps to create an Internet-restricted (offline) AWS VPC or see <a href=https://docs.aws.amazon.com/vpc/latest/userguide/working-with-vpcs.htmlhttps:/>Work with VPCs</a><a href=https://docs.aws.amazon.com/vpc/latest/userguide/working-with-vpcs.html>AWS VPC documentation</a> in AWS documentation. The offline VPC must not have a NAT or Internet gateway. Create your offline VPC with private subnets only.</p><ol><li>Create a VPC.<ol><li>Log in to your AWS Console and select VPC service.</li><li>Create your VPC with Valid CIDR and name.</li></ol></li><li>Create 3 Private Subnets.
Click <strong>Subnet</strong> and create your subnet with:<ul><li>Private Subnet 1, Private Subnet 2 and Private Subnet 3 valid Name & VPC.</li><li>Valid Subnet range which is valid IPv4 CIDR Block.</li></ul></li><li>Create Private Route Table.<ul><li>Create a Route table in the same VPC.</li><li>Make sure you selected the right VPC and gave a proper tag.</li></ul></li><li>Add Private Subnet in Private Route Table.<ol><li>Edit the Subnet Association.</li><li>Select the PrivateSubnet checkbox.</li><li>Click <strong>Save</strong>.</li></ol></li><li>Edit DNS Resolution and Hostname.<ol><li>Click <strong>Action</strong> and Edit DNS hostname.</li><li>Select DNS Hostname and click <strong>Save</strong>.</li></ol></li></ol><p><strong>Note:</strong> If you create multiple offline VPCs, also see <a href=https://docs.aws.amazon.com/vpc/latest/tgw/tgw-getting-started.html>Getting started with transit gateways</a> in AWS documentation to create an AWS transit gateway.</p><h3 id=add-vpc-endpoints-into-offline-vpc>Add VPC Endpoints into Offline VPC</h3><p>After you create the offline VPC, you must add the following endpoints to the offline VPC. VPC endpoints enable private connections between your VPC and supported AWS services.</p><p><strong>Service endpoints:</strong></p><ul><li>sts</li><li>ssm</li><li>ec2</li><li>ec2messages</li><li>elasticloadbalancing</li><li>secretsmanager</li><li>ssmmessages</li><li>s3 (gateway type)</li></ul><p>For more information about creating an endpoint service, see <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/create-endpoint-service.html>Create a service powered by AWS PrivateLink</a> in AWS documentation.</p><h2 id=a-idoffline-jumpbox-a-create-an-offline-jumpbox>Create an Offline JumpBox</h2><p>After configuring the network, complete the steps described in this section to set up your jumpbox. You will download the Tanzu CLI to the jumpbox, which you will use to deploy the management cluster and workload clusters. You also keep the Tanzu and Kubernetes configuration files for your deployments on your jumpbox.</p><ol><li><p>Create a jumpbox.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Set up AWS credentials</span>
</span></span><span style=display:flex><span>export AWS_ACCESS_KEY_ID<span style=color:#f92672>=</span>xx
</span></span><span style=display:flex><span>export AWS_SECRET_ACCESS_KEY<span style=color:#f92672>=</span>xx
</span></span><span style=display:flex><span><span style=color:#75715e># Should be a region with at least 3 available AZs</span>
</span></span><span style=display:flex><span>export AWS_REGION<span style=color:#f92672>=</span>us-east-1
</span></span><span style=display:flex><span>export AWS_PAGER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Set up AWS profile</span>
</span></span><span style=display:flex><span>aws ec2 describe-instances --profile &lt;profile name&gt;
</span></span><span style=display:flex><span>export AWS_PROFILE<span style=color:#f92672>=</span>&lt;profile name&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set offline VPC and private subnet ID</span>
</span></span><span style=display:flex><span>export vpcId<span style=color:#f92672>=</span>&lt;offline vpc id&gt;
</span></span><span style=display:flex><span>export prisubnetId<span style=color:#f92672>=</span>&lt;private subnet id&gt;
</span></span><span style=display:flex><span>export WORKING_DIR<span style=color:#f92672>=</span>&lt;local working dir&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws ec2 create-security-group --group-name <span style=color:#e6db74>&#34;jumpbox-ssh&#34;</span> --description <span style=color:#e6db74>&#34;To Jumpbox&#34;</span> --vpc-id <span style=color:#e6db74>&#34;</span>$vpcId<span style=color:#e6db74>&#34;</span> --output json &gt; $WORKING_DIR/sg_jumpbox_ssh
</span></span><span style=display:flex><span>aws ec2 create-tags --resources <span style=color:#66d9ef>$(</span>jq -r .GroupId $WORKING_DIR/sg_jumpbox_ssh<span style=color:#66d9ef>)</span> --tags Key<span style=color:#f92672>=</span>Name,Value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jumpbox-ssh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Allow SSH access to jumpbox</span>
</span></span><span style=display:flex><span>aws ec2 authorize-security-group-ingress --group-id  <span style=color:#66d9ef>$(</span>jq -r .GroupId $WORKING_DIR/sg_jumpbox_ssh<span style=color:#66d9ef>)</span> --protocol tcp --port <span style=color:#ae81ff>22</span> --cidr <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Save this file (or use an existing team keypair)</span>
</span></span><span style=display:flex><span>aws ec2 create-key-pair --key-name tkg-kp --query <span style=color:#e6db74>&#39;KeyMaterial&#39;</span> --output text &gt; tkgkp.pem
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>400</span> tkgkp.pem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find an Amazon Machine Image (AMI) for your region https://cloud-images.ubuntu.com/locator/ec2/ (20.04)&lt;_Correct?_&gt;</span>
</span></span><span style=display:flex><span>aws ec2 run-instances --image-id ami-036d46416a34a611c --count <span style=color:#ae81ff>1</span> --instance-type t2.xlarge --key-name tkg-kp --security-group-ids  <span style=color:#66d9ef>$(</span>jq -r .GroupId $WORKING_DIR/sg_jumpbox_ssh<span style=color:#66d9ef>)</span>   --subnet-id $prisubnetId  --tag-specifications <span style=color:#e6db74>&#39;ResourceType=instance,Tags=[{Key=Name,Value=tkg-jumpbox}]&#39;</span> --block-device-mappings <span style=color:#e6db74>&#39;DeviceName=/dev/sda1,Ebs={VolumeSize=64}&#39;</span> &gt; $WORKING_DIR/instance_jb_starting
</span></span></code></pre></div></li><li><p>Wait a few minutes for the instance to start. Then SSH to the jumpbox.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 describe-instances --instance-id <span style=color:#66d9ef>$(</span>jq -r <span style=color:#e6db74>&#39;.Instances[0].InstanceId&#39;</span> $WORKING_DIR/instance_jb_starting<span style=color:#66d9ef>)</span> &gt; $WORKING_DIR/instance_jb_started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo j IP: <span style=color:#66d9ef>$(</span>jq -r <span style=color:#e6db74>&#39;.Reservations[0].Instances[0].PrivateIpAddress&#39;</span> $WORKING_DIR/instance_jb_started<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssh ubuntu@<span style=color:#66d9ef>$(</span>jq -r <span style=color:#e6db74>&#39;.Reservations[0].Instances[0].PrivateIpAddress&#39;</span> $WORKING_DIR/instance_jb_started<span style=color:#66d9ef>)</span> -i tkgkp.pem
</span></span></code></pre></div></li><li><p>Log in to the jumpbox to install the necessary packages and configurations. Then reboot.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install docker.io
</span></span><span style=display:flex><span>sudo apt install screen
</span></span><span style=display:flex><span>sudo adduser ubuntu docker
</span></span><span style=display:flex><span>sudo reboot
</span></span></code></pre></div></li><li><p>Download the Tanzu CLI and other Linux utilities from the Tanzu Kubernetes Grid <a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=TKG-142&productId=988&rPId=73652">Download Product</a> site.</p></li><li><p>Copy the files and binaries to the jumpbox.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>scp -i tkgkp.pem tanzu-cli-bundle-linux-amd64.tar kubectl-linux-v1.21.8+vmware.1-142.gz ubuntu@<span style=color:#66d9ef>$(</span>jq -r <span style=color:#e6db74>&#39;.Reservations[0].Instances[0].PrivateIpAddress&#39;</span> $WORKING_DIR/instance_jb_started<span style=color:#66d9ef>)</span>:/home/ubuntu
</span></span></code></pre></div></li><li><p>Connect to the jumpbox.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh ubuntu@&lt;jumpbox-ip&gt; -i tkgkp.pem
</span></span></code></pre></div></li><li><p>Install the Tanzu CLI.</p><p>Run the session in <code>screen</code> in case your SSH connection is terminated.
If your connection is terminated, you can reattach to the screen session
with <code>screen -r</code> once you have reconnected.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>screen
</span></span><span style=display:flex><span>tar -xzvf tanzu-cli-bundle-linux-amd64.tar.gz
</span></span><span style=display:flex><span>gunzip kubectl-*.gz
</span></span><span style=display:flex><span>sudo install kubectl-linux-* /usr/local/bin/kubectl
</span></span><span style=display:flex><span>cd cli/
</span></span><span style=display:flex><span>sudo install core/*/tanzu-core-linux_amd64 /usr/local/bin/tanzu
</span></span><span style=display:flex><span>gunzip *.gz
</span></span><span style=display:flex><span>sudo install imgpkg-linux-amd64-* /usr/local/bin/imgpkg
</span></span><span style=display:flex><span>sudo install kapp-linux-amd64-* /usr/local/bin/kapp
</span></span><span style=display:flex><span>sudo install kbld-linux-amd64-* /usr/local/bin/kbld
</span></span><span style=display:flex><span>sudo install vendir-linux-amd64-* /usr/local/bin/vendir
</span></span><span style=display:flex><span>sudo install ytt-linux-amd64-* /usr/local/bin/ytt
</span></span><span style=display:flex><span>cd ..
</span></span><span style=display:flex><span>tanzu plugin sync
</span></span><span style=display:flex><span>tanzu config init
</span></span></code></pre></div><p>Running the <code>tanzu config init</code> command for the first time creates the <code>~/.config/tanzu/tkg</code> subdirectory, which contains the Tanzu Kubernetes Grid configuration files.</p></li></ol><h2 id=a-idprivate-repo-a-create-and-set-up-a-private-container-registry>Create and Set Up a Private Container Registry</h2><p>This registry should run outside of Tanzu Kubernetes Grid and is separate from any registry deployed as a shared service for clusters.</p><ul><li>You can configure the container registry with SSL certificates signed by a trusted CA, or with self-signed certificates.</li><li>The registry must not implement user authentication. For example, if you use a Harbor registry, the project must be public, not private.</li><li>You can set up this private registry on an offline jumpbox machine or set it up on another ec2 instance inside an offline VPC.</li></ul><h3 id=install-harbor>Install Harbor</h3><ul><li>Download the <a href=https://github.com/goharbor/harbor/releases>binaries for the latest Harbor release</a>.</li><li>Follow the Harbor <a href=https://goharbor.io/docs/2.0.0/install-config/>Installation and Configuration</a> instructions in the Harbor documentation.</li></ul><h2 id=a-idcopy-tkg-img-a-copy-the-container-images-required-to-deploy-tanzu-kubernetes-grid>Copy the container images required to deploy Tanzu Kubernetes Grid.</h2><p>Copy the container images required to deploy Tanzu Kubernetes Grid on AWS to a private registry in a physically air-gapped, offline environment. This procedure uses the scripts <code>download-images.sh</code>, <code>gen-publish-images-totar.sh</code>, and <code>gen-publish-images-fromtar.sh</code> to:</p><ul><li>Copy the images from the Tanzu Kubernetes Grid public registry and save them locally in tar format on an offline jumpbox.</li><li>Extract the images from the tar files and copy them to a private registry.</li></ul><p>See <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-image-copy-airgapped.html>Copy the container images required to deploy Tanzu Kubernetes Grid</a> for more detailed instructions.</p><h2 id=a-idprepenv-a-prepare-an-internet-restricted-environment>Prepare an Internet-Restricted Environment</h2><p>Before you can deploy management clusters and Tanzu Kubernetes clusters in an Internet-restricted environment, you need to prepare the environment. Follow the instructions in <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-airgapped-environments.html>Prepare an Internet-Restricted Environment</a>.</p><h2 id=a-idinstall-tkga-deploy-a-tanzu-kubernetes-grid-management-cluster>Deploy a Tanzu Kubernetes Grid Management Cluster</h2><p>Create and edit a YAML configuration file. Then use the configuration file with CLI commands to deploy a management cluster.</p><p>This section describes how to deploy a Tanzu Kubernetes Grid management cluster from a configuration file using the Tanzu CLI.</p><p>Before creating a management cluster using the Tanzu CLI, define the base configuration for the cluster in a YAML file. Specify this file by using the <code>tanzu management-cluster create</code> command with the the <code>--file</code> option.</p><p><strong>Note</strong> In the configuration file for the management cluster, enable the AWS internal load balancer as follows:</p><p><code>AWS_LOAD_BALANCER_SCHEME_INTERNAL: "true"</code>
Using an internal load balancer scheme prevents the Kubernetes API server for the cluster from being accessed and routed over the Internet.</p><p>To create a new Tanzu Kubernetes Grid management cluster, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tanzu management-cluster create --file path/to/cluster-config-file.yaml
</span></span></code></pre></div><p>For more information about deploying a management cluster from a configuration file, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-deploy-cli.html>Deploy Management Clusters from a Configuration File</a>.</p><h2 id=a-idexamine-clustera-examine-the-management-cluster-deployment>Examine the Management Cluster Deployment</h2><p>When the management cluster is deployed, either from the installer interface or from a configuration file using Tanzu CLI, Tanzu Kubernetes Grid uses a Kubernetes in Docker kind cluster on the jumpbox to create a temporary management cluster. kind is a tool for running Kubernetes clusters locally using Docker containers as Kubernetes nodes.</p><p>Tanzu Kubernetes Grid uses the temporary management cluster to provision the final management cluster on AWS. For information about how to examine and verify your Tanzu Kubernetes Grid management cluster deployment, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-mgmt-clusters-verify-deployment.html>Examine the Management Cluster Deployment</a>.</p><h2 id=a-iddeploy-workload-clustera-deploy-workload-clusters>Deploy Workload Clusters</h2><p>After deploying the management cluster, you can create the workload clusters. The context of the management cluster is updated automatically, so you can begin interacting with the management cluster.</p><p>Run the following command to create a basic workload cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tanzu cluster create &lt;cluster_name&gt; --plan<span style=color:#f92672>=</span>prod
</span></span></code></pre></div><p>Workload clusters can be highly customized through YAML manifests and applied to the management cluster for deployment and lifecycle management. To generate a YAML template to update and modify to your own needs, use the <code>--dry-run</code> switch. Edit the manifests to meet your requirements and apply them to the cluster.</p><p><strong>Example:</strong></p><pre tabindex=0><code>tanzu cluster create &lt;workload_cluster&gt; --plan=prod --worker-machine-count 3 --dry-run
</code></pre><p>After the workload cluster is created, the current context changes to the new workload cluster.</p><p>For more information on cluster lifecycle and management, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-cluster-lifecycle-index.html>Manage Clusters</a>.</p><h3 id=troubleshooting-tips-for-tanzu-kubernetes-grid>Troubleshooting Tips for Tanzu Kubernetes Grid</h3><p>For tips to help you to troubleshoot common problems that you might encounter when installing Tanzu Kubernetes Grid and deploying Tanzu Kubernetes clusters, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-troubleshooting-tkg-tips.html>Troubleshooting Tips for Tanzu Kubernetes Grid</a>.</p><h2 id=a-idinstall-packagesa-install-and-configure-packages-into-workload-clusters>Install and Configure Packages into Workload Clusters</h2><p>A package in Tanzu Kubernetes Grid is a collection of related software that supports or extends the core functionality of the Kubernetes cluster in which the package is installed. Tanzu Kubernetes Grid includes two types of packages, core packages and user-managed packages. For more information about packages in Tanzu Kubernetes Grid, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-index.html>Install and Configure Packages</a>.</p><h3 id=core-packages>Core Packages</h3><p>Tanzu Kubernetes Grid automatically installs the core packages during cluster creation. For more information about core packages, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-core-index.html>Core Packages</a>.</p><h3 id=user-managed-packages>User-Managed Packages</h3><p>A user-managed package is an optional component of a Kubernetes cluster that you can install and manage with the Tanzu CLI. These packages are installed after cluster creation. User-managed packages are grouped into package repositories in the Tanzu CLI. If a package repository that contains user-managed packages is available in the target cluster, you can use the Tanzu CLI to install and manage any of the packages from that repository.</p><p>Using the Tanzu CLI, you can install user-managed packages from the built-in <code>tanzu-standard</code> package repository or from package repositories that you add to your target cluster. From the <code>tanzu-standard</code> package repository, you can install the Cert Manager, Contour, Fluent Bit, Grafana, Harbor, and Prometheus packages. For more information, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-cli-reference-packages.html>User-Managed Packages</a>.</p><p><strong>Recommended packages:</strong></p><ul><li><strong>Cert Manager</strong> for automating the management and issuance of TLS certificates. See <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-cert-manager.html>Installing Cert Manager</a>.</li><li><strong>Contour</strong> for ingress control. See <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-ingress-contour.html>Implementing Ingress Control with Contour</a>.
For use a private load balancer, set <code>service.beta.kubernetes.io/aws-load-balancer-internal: "true"</code> in the annotations for the service. This setting also applies to the Contour ingress and controls.</li><li><strong>Fluent Bit</strong> for log processing and forwarding. See <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-logging-fluentbit.html>Implementing Log Forwarding with Fluent Bit</a></li><li><strong>Prometheus</strong> and <strong>Grafana</strong> for monitoring. See <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-monitoring.html>Implementing Monitoring with Prometheus and Grafana</a></li><li><strong>Multus</strong> for multi networking. <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-cni-multus.html>Implementing Multiple Pod Network Interfaces with Multus</a></li></ul><h2 id=a-idlogsa-logs-and-troubleshooting>Logs and Troubleshooting</h2><p>For information about how to find the Tanzu Kubernetes Grid logs, how to troubleshoot frequently encountered Tanzu Kubernetes Grid issues, and how to use the Crash Recovery and Diagnostics tool, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-troubleshooting-tkg-index.html>Logs and Troubleshooting</a>.</p><h2 id=a-idcluster-mgmt-a-delete-clusters>Delete Clusters</h2><p>The procedures in this section are optional. They are provided in case you want to clean up your production or lab environment.</p><h3 id=delete-a-workload-cluster>Delete a Workload Cluster</h3><p>To delete a provisioned workload cluster, first set your context back to the management cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl config use-context <span style=color:#f92672>[</span>mgmt_cluster_name<span style=color:#f92672>]</span>-admin@<span style=color:#f92672>[</span>mgmt_cluster_name<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>From the management cluster context, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tanzu cluster delete &lt;cluster_name&gt;
</span></span></code></pre></div><h3 id=delete-a-management-cluster>Delete a Management Cluster</h3><p>Use this procedure to delete the management cluster as well as all of the AWS objects that Tanzu Kubernetes Grid created, such as VPC, subnets, and NAT Gateways.</p><p><strong>Note</strong>: Be sure to wait until all the workload clusters have been reconciled before deleting the management cluster, or you will need to manually clean up the infrastructure.</p><p>Run the following command to delete the management cluster and related objects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tanzu cluster delete &lt;management-cluster-name&gt;
</span></span></code></pre></div><h2 id=a-idstig-fips-aair-gapped-stigfips-deployment-on-aws>Air-Gapped STIG/FIPS Deployment on AWS</h2><p>For how to deploy a STIG-hardened management/FIPS cluster to an air-gapped AWS environment, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-security-airgap-stig-aws.html>Deploy a STIG-Hardened Management Cluster to an Air-gapped AWS VPC</a>.</p><h2 id=a-idupgrade-tkg-atanzu-kubernetes-grid-upgrade>Tanzu Kubernetes Grid Upgrade</h2><p>For information about how to upgrade to Tanzu Kubernetes Grid 1.5, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-upgrade-tkg-index.html>Tanzu Kubernetes Grid Upgrade</a>.
 </p></div></div><div class="loader-container-toc col-lg-2 w-100" style=display:none><span class=spinner></span></div><div class="rhs-right-container d-none d-lg-block col-lg-2"><div class=rhs-right-panel><div class="rhs-right-panel-header d-flex justify-content-between"><div class=rhs-right-panel-title>In this article</div></div><div id=right-toc-div-id class="onpage-toc-container d-flex flex-column"><nav id=TableOfContents><ul><li><a href=#deploying-with-vmware-service-installer-for-tanzu>Deploying with VMware Service Installer for Tanzu</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#overview-of-the-deployment-steps>Overview of the Deployment Steps</a></li><li><a href=#a-idaws-infra-a-set-up-aws-infrastructure>Set up AWS Infrastructure</a><ul><li><a href=#create-an-internet-restricted-virtual-private-cloud-vpc>Create an Internet-Restricted Virtual Private Cloud (VPC)</a></li><li><a href=#add-vpc-endpoints-into-offline-vpc>Add VPC Endpoints into Offline VPC</a></li></ul></li><li><a href=#a-idoffline-jumpbox-a-create-an-offline-jumpbox>Create an Offline JumpBox</a></li><li><a href=#a-idprivate-repo-a-create-and-set-up-a-private-container-registry>Create and Set Up a Private Container Registry</a><ul><li><a href=#install-harbor>Install Harbor</a></li></ul></li><li><a href=#a-idcopy-tkg-img-a-copy-the-container-images-required-to-deploy-tanzu-kubernetes-grid>Copy the container images required to deploy Tanzu Kubernetes Grid.</a></li><li><a href=#a-idprepenv-a-prepare-an-internet-restricted-environment>Prepare an Internet-Restricted Environment</a></li><li><a href=#a-idinstall-tkga-deploy-a-tanzu-kubernetes-grid-management-cluster>Deploy a Tanzu Kubernetes Grid Management Cluster</a></li><li><a href=#a-idexamine-clustera-examine-the-management-cluster-deployment>Examine the Management Cluster Deployment</a></li><li><a href=#a-iddeploy-workload-clustera-deploy-workload-clusters>Deploy Workload Clusters</a><ul><li><a href=#troubleshooting-tips-for-tanzu-kubernetes-grid>Troubleshooting Tips for Tanzu Kubernetes Grid</a></li></ul></li><li><a href=#a-idinstall-packagesa-install-and-configure-packages-into-workload-clusters>Install and Configure Packages into Workload Clusters</a><ul><li><a href=#core-packages>Core Packages</a></li><li><a href=#user-managed-packages>User-Managed Packages</a></li></ul></li><li><a href=#a-idlogsa-logs-and-troubleshooting>Logs and Troubleshooting</a></li><li><a href=#a-idcluster-mgmt-a-delete-clusters>Delete Clusters</a><ul><li><a href=#delete-a-workload-cluster>Delete a Workload Cluster</a></li><li><a href=#delete-a-management-cluster>Delete a Management Cluster</a></li></ul></li><li><a href=#a-idstig-fips-aair-gapped-stigfips-deployment-on-aws>Air-Gapped STIG/FIPS Deployment on AWS</a></li><li><a href=#a-idupgrade-tkg-atanzu-kubernetes-grid-upgrade>Tanzu Kubernetes Grid Upgrade</a></li></ul></nav></div></div></div></section></div><footer class=tech-pub-footer><div id=page-footer><section class="footer-component footer-container"><div class=personalization_div_1 style=min-height:1px></div><div class=personalization_div_2 style=min-height:1px></div><div class=container><div class=content><div class=row><div class="col-lg-12 col-md-12"><footer class=footer><div class=row><div class="col-lg-2 col-md-12 mb-40 mt-3"><a class=footer-vmware-logo href=https://www-lt.vmware.com/ name="nav_footer : VMware Logo"><picture class=float-lg-left><source media=(max-width:800px) srcset=https://www-lt.vmware.com/content/dam/digitalmarketing/vmware/vm-logo-big.png.imgo.jpeg><img loading=lazy class=vmware-logo src=/validated-solutions/img/vm-logo-big.png alt=VMware title=VMware></picture></a></div></div></footer></div></div></div></div></section></div></footer><script src=/validated-solutions/js/pageStore.js></script>
<script src=/validated-solutions/js/main.js></script></body></html>