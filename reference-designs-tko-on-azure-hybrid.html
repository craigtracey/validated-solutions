<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="last modified" content="27/09/2021 12:47:24"><meta name=abstract content><meta name=author content="dpavel@vmware.com"><meta name=primary-product-name content="MD2Docs-TestBed"><meta name=primary-product-version content="1"><meta name=description content><meta name=guid content="GUID-1Intro"><meta name=language content="en"><meta name=title content="Basic Markdown"><meta name=publication-author content="dpavel@vmware.com"><meta property="og:title" content="Basic Markdown"><meta property="og:image" content="https://docs-uat.vmware.com/uicontent/images/vmware-docs-default.png"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html"><meta name=cdf-utag content="https://tags.tiqcdn.com/utag/vmware/cdf-privacy/qa/utag.js"><link rel=stylesheet type=text/css href=/validated-solutions/css/commonltr.css><link rel=stylesheet type=text/css href=/validated-solutions/css/non-draft.vmware.productdocs.css><link rel=canonical href=https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html><link class=user href=/validated-solutions/css/responsive.css rel=stylesheet type=text/css><link rel=icon href=https://www.vmware.com/favicon.ico type=image/x-icon><link rel=stylesheet href=/validated-solutions/css/v2-global.20200911172508.css><title>Docs Preview</title></head><body><header class=tech-pub-header><div id=header class="global-header col-12"><div class="row desktop-header h-100"><div class="col col-md-3 align-self-center header-logo-wrapper"><div class="d-inline-flex align-items-center justify-content-start w-100"><div class="d-inline-flex align-items-center w-100"><span class="my-auto d-md-none header-menu-icon"><i class="fa fa-bars"></i></span><h1><a href=https://docs-uat-staging.vmware.com/ class="d-inline-flex align-items-center my-auto nav-link header-logo-url pl-md-1 pl-xl-3"><span class=mr-2><img src=/validated-solutions/img/vm-logo.png alt="VMware Logo"></span>
<span class=vm-logo-title>Docs Preview</span></a></h1></div><div class=align-items-center><span id=toggleTOC class="d-md-none header-toc-icon"><i class="fa fa-ellipsis-v px-2"></i></span></div></div></div></div></div><div class="col-12 vmware-gradient w-100 px-0 mx-0"></div></header><div class="tech-pub-container main-container d-flex flex-column pubView"><section class="tech-pub-section d-flex flex-md-row"><div class="lhs lhs-container col-md-4 col-lg-3" style=display:block><div class=backdrop></div><div class=left-panel><div class="panel-header position-relative hidden-xs"><div class="panel-header-left d-flex justify-content-between align-items-center"><span class=container-collapse-expand><span id=expand-all-id class=expand-tree onclick=expandAll()><span class="lhs-expand-shape align-middle"><i class="fa fa-chevron-down"></i></span>
<span class="expand-text align-middle" data-i18n data-i18n-expand-all>Expand All</span></span>
<span id=collapse-all-id class="collapse-tree hide" onclick=collapseAll()><span class="lhs-collapse-shape align-middle"><i class="fa fa-chevron-up"></i></span>
<span class="collapse-text align-middle" data-i18n data-i18n-collapse-all>Collapse All</span></span></span></div></div><div class="panel-content p-2" id=left_toc><div class="dropdown collection-dropdown-container w-100"><button class="btn w-100 text-left dropdown-toggle collection-name" type=button id=collectionDropdwnBtn data-toggle=dropdown aria-haspopup=true aria-label="Collection Dropdown" aria-expanded=false>
<span class=label></span>
<span class="float-right icon-down pl-2 fa fa-angle-down"></span></button><div class="dropdown-menu w-100" id=collectionMenu aria-labelledby=collectionDropdwnBtn></div></div><div id=tree class=mt-2></div><div class="w-100 px-2 toc-product-container"><a class="mr-3 my-2 position-relative toc-product-link"><span class=toc-product-name></span>
<span class=localized-page-name>Product Documentation</span></a></div><ul class=rm-default-ul-styles></ul></div></div></div><div class="rhs rhs-container col-md-8 col-lg-7" style=display:block><div class=rhs-top><div class="rhs-top-container-top d-flex flex-row justify-content-between"><h1 class=primary-header id=vmware-tanzu-kubernetes-grid-on-hybrid-cloud-azure>VMware Tanzu Kubernetes Grid on Hybrid-Cloud Azure</h1></div><div class="rhs-top-container-middle d-flex flex-row justify-content-between"></div><div class=rhs-top-container-bottom><div class=last-updated-container><div class=calendar-icon><svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path class="clr-i-outline clr-i-outline-path-1" d="M32.25 6H29V8h3V30H4V8H7V6H3.75A1.78 1.78.0 002 7.81V30.19A1.78 1.78.0 003.75 32h28.5A1.78 1.78.0 0034 30.19V7.81A1.78 1.78.0 0032.25 6z"/><rect class="clr-i-outline clr-i-outline-path-2" x="8" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-3" x="14" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-4" x="20" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-5" x="26" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-6" x="8" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-7" x="14" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-8" x="20" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-9" x="26" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-10" x="8" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-11" x="14" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-12" x="20" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-13" x="26" y="24" width="2" height="2"/><path class="clr-i-outline clr-i-outline-path-14" d="M10 10a1 1 0 001-1V3A1 1 0 009 3V9a1 1 0 001 1z"/><path class="clr-i-outline clr-i-outline-path-15" d="M26 10a1 1 0 001-1V3a1 1 0 00-2 0V9a1 1 0 001 1z"/><rect class="clr-i-outline clr-i-outline-path-16" x="13" y="6" width="10" height="2"/><rect x="0" y="0" width="36" height="36" fill-opacity="0"/></svg></div><span class=last-updated-label data-i18n-updated-on>Updated on</span>
&nbsp;
<span class=last-updated-date-ph>9/22/22</span></div></div></div><div class="rhs-center article-wrapper" id=content-div-id><h1 id=vmware-tanzu-kubernetes-grid-on-hybrid-cloud-azure>VMware Tanzu Kubernetes Grid on Hybrid-Cloud Azure</h1><p><em>A validated augmentation for the <a href=tko-on-azure.md>TKO on Azure reference architecture</a></em></p><h2 id=summary>Summary</h2><p>Building on the reference architecture provided for Tanzu for Kubernetes Operations (TKO) on Azure, this document outlines the modifications that should be considered for a hybrid-cloud architecture. This type of cloud architecture maintains some dependency or connectivity to on-prem networks and systems, and special considerations must be made to co-exist within this scenario. This reference architecture assumes on-premises connectivity via ExpressRoute or a VPN Gateway, private IP (i.e. not Internet-routable) only access, and <em>managed</em> egress routing.</p><p>The solution areas for a hybrid-cloud-accessible TKGm solution can be summarized as:</p><ul><li>Network & WAN Architecture</li><li>Network Security (Ingress/Egress)</li><li>Azure Service Extension</li><li>Platform Configuration</li></ul><p>Further, though TKO components are assumed to be in the cloud environment, the solution allows for hybrid placement and each location can reach the other.</p><p><img src=img/reference-designs/tko-on-azure-hybrid/tkgm-azure-hybrid.png alt="Overview Hybrid Cloud TKG Architecture"></p><h2 id=network--wan-architecture>Network & WAN Architecture</h2><p>A hybrid-cloud architecture may exist within a classic hub-spoke topology, or may have been built using Azure vWAN. As with the <a href=tko-on-azure.md><em>Reference</em></a> approach, any VNET topology will work that is supported by the encumbent networking requirements. Depicted in the diagram above, a single VNET houses everything for the TKO solution, administration, and even on-premises integration. This design would fit nicely into either a hub-spoke or vWAN topology and could be considered the &lsquo;spoke&rsquo; subscription and VNET in this case. Should VNET boundaries be desired between components, it is not necessary that they have mesh peering, but that they are configured for loosely-restricted network access between the related VNETs (e.g. firewall NVA fulfilling access controls and routing).</p><p>The diagram also shows VNET Gateway connections such as those found in a VPN or ExpressRoute configuration - foundational to a hybrid-cloud architecture. Any specifics regarding the size or assignment of Tanzu subnet CIDRs should follow the requirements of the network and WAN owners, with respect to Azure&rsquo;s minimum and maximum (TKGm recommends minimum /28).</p><p>As an element of the datacenter extension into cloud, the networking team may be prescribing the use of <a href=https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm><em>forced tunneling</em></a> by configuring the default route in BGP over ExpressRoute, or through creating User-Defined Route Tables (UDR) for VPN connections. As seen in <em>Network Security</em> below, this feature may be particular to your security requirements.</p><h2 id=network-security>Network Security</h2><h3 id=azure-load-balancer>Azure Load Balancer</h3><p>Azure networks have a preferred order to build <em>effective routes</em> and forced tunneling overrides the native Internet-out path. <strong>If the default route (0.0.0.0/0) is not overridden, Azure Load Balancers marked with a ðŸš« in the diagram will be active for your solution.</strong> Generally speaking, a forced tunneling solution that utilizes transparent proxy or next-gen firewalls will be the simplest and most effective way to control outbound Internet access. However, if a traditional proxy is being used within the organization, additional configuration will be necessary both within the Tanzu platform as well as on the bootstrap virtual machine. A proxy configuration alone will not guarantee that egress follows this path. Virtual Machines inherit an egress NAT automatically even when no public IP address is configured - common ways to prevent this are via route tables or Network Security Groups.</p><h3 id=network-security-groups-nsg>Network Security Groups (NSG)</h3><p>A suggested layout for Resource Groups is offered within the diagram above. An important note here is that while a separate team may be responsible for the VNET and security services within your subscription, TKG&rsquo;s worker subnet NSG must be co-located with the VNET&rsquo;s Resource Group and be named according to a pattern:</p><blockquote><p><code>{tkg_cluster_name}-node-nsg</code></p></blockquote><p>Subnet NSGs may be configured to NetSec requirements with the following considerations:</p><table><thead><tr><th>Description</th><th>Source</th><th>Destination</th><th style=text-align:right>Protocol</th><th>Port</th></tr></thead><tbody><tr><td>SSH Access</td><td>on-prem</td><td>&ldquo;Admin&rdquo; subnetâ€ </td><td style=text-align:right>SSH</td><td>22</td></tr><tr><td>DNS Forwarding</td><td>on-prem (DNS Server(s))</td><td>&ldquo;Admin&rdquo; subnet</td><td style=text-align:right>DNS-udp</td><td>53</td></tr><tr><td>k8s API</td><td>on-prem, admin</td><td>all Control Plane(s)</td><td style=text-align:right>tcp-tls</td><td>6443</td></tr><tr><td>Pinnipedâ€ â€  concierge to supervisor (identity broker)</td><td>workload cluster</td><td>management cluster</td><td style=text-align:right>tcp</td><td>31234</td></tr></tbody></table><blockquote><p>â€ Reference to the &ldquo;admin&rdquo; subnet (pictured at top) will vary and may also require on-prem or other sources.</p><p>â€ â€ Pinniped is an identity broker and a choice. If it is unused, then the port above will not be needed.</p><p><strong>NOTE:</strong> Other services may need to be allowed within these configured NSGs for things not directly related to Tanzu Kubernetes Grid or TKO (e.g. DNS, NTP, internal services).</p></blockquote><h2 id=load-balancers>Load Balancers</h2><p>The <a href=https://cluster-api.sigs.k8s.io/>Cluster API</a> for Azure (CAPZ) will add outbound load balancers to aggregate Internet egress through a single, reliable IP that can be used for outbound rules or whitelisting on the destination. In many hybrid-cloud solutions, the egress IP is actually intended to be an on-prem edge solution as indicated above. Although the load balancers will be created and configured for outbound Internet access, <strong>Azure&rsquo;s order of routing prefers the User-Defined Route (UDR).</strong> If there is no <em>override</em> for the default route (e.g. 0.0.0.0/0 &ndash;> Internet), then Azure will prefer the outbound NAT rules provided by the Standard Azure Load Balancer of the solution. Your network requirements may have additional routes added to the Route Table listing as needed.</p><h2 id=azure-service-extension>Azure Service Extension</h2><h3 id=dns>DNS</h3><p>DNS represents one of the largest differences in a hybrid-cloud approach. TKGm uses Azure Private DNS and is therefore inaccessible from an on-premises network without some additional steps taken. Microsoft has detailed this within their solutions <a href=https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#virtual-network-and-on-premises-workloads-using-a-dns-forwarder>documentation</a>, but here are the components as a summary:</p><p><img src=https://docs.microsoft.com/en-us/azure/private-link/media/private-endpoint-dns/hybrid-scenario.png alt="On-Premises Azure Private DNS Resolution"></p><p>The most important elements of this diagram is the inclusion of a DNS forwarder <em>within</em> your VNET where the private DNS zone is linked, and the forwarding domain configuration for those private zones applied to the local DNS solution (on-prem). The DNS forwarder itself can be as simple as a Linux virtual machine running bind9. The forwarder machine can forward <strong>all</strong> requests to Azure DNS because the on-prem DNS solution will use zone forwarders for Azure private zones (explicit).</p><p>Name resolution for on-premises targets must also be available to the TKGm cluster for fully hybrid connectivity. DNS should be configured at the VNET level to point to a user-defined or <em>custom</em> DNS server. This should be configured to use the customer&rsquo;s DNS solution to include on-premises zones. Alternatively, the forwarder can also be configured to forward on-premises zones to another DNS server, while maintaining Azure-specific zones are forwarded to Azure DNS (168.63.129.16).</p><h3 id=azure-key-vault>Azure Key Vault</h3><blockquote><p><strong>OPTIONAL</strong></p></blockquote><p>As shown in the design at the head of this document, the <em>Admin</em> subnet and/or Resource Group may contain other services relevant to the solution or enterprise. Azure Key Vault is used in the <a href=../../automation/tko-on-azure-hybrid/readme.md>deployment guide</a> for this Reference Architecture to store secret and non-secret parameters that can be used to drive automation for TKG management and workload clusters.</p><p>It is recommended that all such <em>cloud service</em> resources are provided via Private Links or otherwise access-restricted means to ensure they are not addressable via the public Internet, unless that is explicitly understood and desired.</p><h2 id=platform-configuration---architecture-enablement>Platform Configuration - Architecture Enablement</h2><h3 id=tanzu-kubernetes-grid>Tanzu Kubernetes Grid</h3><p>The hybrid-cloud TKGm solution depicted in this reference architecture depends upon v1.4. This version provides a cluster configuration flag of <em>AZURE_ENABLE_PRIVATE_CLUSTER</em> which assigns a private IP address from the associated subnet to the ingress Azure Load Balancer. In addition, TKG will deploy proxy configuration details to other members of the solution given the following configuration directives:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>TKG_HTTP_PROXY_ENABLED: true
</span></span><span style=display:flex><span>TKG_HTTP_PROXY: http://<span style=color:#f92672>{</span>target:port<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>TKG_HTTPS_PROXY: http://<span style=color:#f92672>{</span>target:port<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>TKG_NO_PROXY: <span style=color:#f92672>{</span>domain.com, 10.0.0.0/8, et al<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>In addition to these TKG-related configuration directives, you will also need to setup the <em>bootstrap</em> VM with proxy configuration matching these, but using the standard environment variables <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>, and <code>NO_PROXY</code>. There are other built-in apps that may require their own proxy configuration like <code>apt</code> as well.</p><p>Additional details can be found within the deployment code <a href=../../automation/tko-on-azure-hybrid/readme.md>example</a> (Terraform)&mldr;</p></div></div><div class="loader-container-toc col-lg-2 w-100" style=display:none><span class=spinner></span></div><div class="rhs-right-container d-none d-lg-block col-lg-2"><div class=rhs-right-panel><div class="rhs-right-panel-header d-flex justify-content-between"><div class=rhs-right-panel-title>In this article</div></div><div id=right-toc-div-id class="onpage-toc-container d-flex flex-column"><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#network--wan-architecture>Network & WAN Architecture</a></li><li><a href=#network-security>Network Security</a><ul><li><a href=#azure-load-balancer>Azure Load Balancer</a></li><li><a href=#network-security-groups-nsg>Network Security Groups (NSG)</a></li></ul></li><li><a href=#load-balancers>Load Balancers</a></li><li><a href=#azure-service-extension>Azure Service Extension</a><ul><li><a href=#dns>DNS</a></li><li><a href=#azure-key-vault>Azure Key Vault</a></li></ul></li><li><a href=#platform-configuration---architecture-enablement>Platform Configuration - Architecture Enablement</a><ul><li><a href=#tanzu-kubernetes-grid>Tanzu Kubernetes Grid</a></li></ul></li></ul></nav></div></div></div></section></div><footer class=tech-pub-footer><div id=page-footer><section class="footer-component footer-container"><div class=personalization_div_1 style=min-height:1px></div><div class=personalization_div_2 style=min-height:1px></div><div class=container><div class=content><div class=row><div class="col-lg-12 col-md-12"><footer class=footer><div class=row><div class="col-lg-2 col-md-12 mb-40 mt-3"><a class=footer-vmware-logo href=https://www-lt.vmware.com/ name="nav_footer : VMware Logo"><picture class=float-lg-left><source media=(max-width:800px) srcset=https://www-lt.vmware.com/content/dam/digitalmarketing/vmware/vm-logo-big.png.imgo.jpeg><img loading=lazy class=vmware-logo src=/validated-solutions/img/vm-logo-big.png alt=VMware title=VMware></picture></a></div></div></footer></div></div></div></div></section></div></footer><script src=/validated-solutions/js/pageStore.js></script>
<script src=/validated-solutions/js/main.js></script></body></html>