<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="last modified" content="27/09/2021 12:47:24"><meta name=abstract content><meta name=author content="dpavel@vmware.com"><meta name=primary-product-name content="MD2Docs-TestBed"><meta name=primary-product-version content="1"><meta name=description content><meta name=guid content="GUID-1Intro"><meta name=language content="en"><meta name=title content="Basic Markdown"><meta name=publication-author content="dpavel@vmware.com"><meta property="og:title" content="Basic Markdown"><meta property="og:image" content="https://docs-uat.vmware.com/uicontent/images/vmware-docs-default.png"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html"><meta name=cdf-utag content="https://tags.tiqcdn.com/utag/vmware/cdf-privacy/qa/utag.js"><link rel=stylesheet type=text/css href=/validated-solutions/css/commonltr.css><link rel=stylesheet type=text/css href=/validated-solutions/css/non-draft.vmware.productdocs.css><link rel=canonical href=https://docs-uat-staging.vmware.com/en/MD2Docs-TestBed/1/md-2-docs-test-bed/GUID-1Intro.html><link class=user href=/validated-solutions/css/responsive.css rel=stylesheet type=text/css><link rel=icon href=https://www.vmware.com/favicon.ico type=image/x-icon><link rel=stylesheet href=/validated-solutions/css/v2-global.20200911172508.css><title>Docs Preview</title></head><body><header class=tech-pub-header><div id=header class="global-header col-12"><div class="row desktop-header h-100"><div class="col col-md-3 align-self-center header-logo-wrapper"><div class="d-inline-flex align-items-center justify-content-start w-100"><div class="d-inline-flex align-items-center w-100"><span class="my-auto d-md-none header-menu-icon"><i class="fa fa-bars"></i></span><h1><a href=https://docs-uat-staging.vmware.com/ class="d-inline-flex align-items-center my-auto nav-link header-logo-url pl-md-1 pl-xl-3"><span class=mr-2><img src=/validated-solutions/img/vm-logo.png alt="VMware Logo"></span>
<span class=vm-logo-title>Docs Preview</span></a></h1></div><div class=align-items-center><span id=toggleTOC class="d-md-none header-toc-icon"><i class="fa fa-ellipsis-v px-2"></i></span></div></div></div></div></div><div class="col-12 vmware-gradient w-100 px-0 mx-0"></div></header><div class="tech-pub-container main-container d-flex flex-column pubView"><section class="tech-pub-section d-flex flex-md-row"><div class="lhs lhs-container col-md-4 col-lg-3" style=display:block><div class=backdrop></div><div class=left-panel><div class="panel-header position-relative hidden-xs"><div class="panel-header-left d-flex justify-content-between align-items-center"><span class=container-collapse-expand><span id=expand-all-id class=expand-tree onclick=expandAll()><span class="lhs-expand-shape align-middle"><i class="fa fa-chevron-down"></i></span>
<span class="expand-text align-middle" data-i18n data-i18n-expand-all>Expand All</span></span>
<span id=collapse-all-id class="collapse-tree hide" onclick=collapseAll()><span class="lhs-collapse-shape align-middle"><i class="fa fa-chevron-up"></i></span>
<span class="collapse-text align-middle" data-i18n data-i18n-collapse-all>Collapse All</span></span></span></div></div><div class="panel-content p-2" id=left_toc><div class="dropdown collection-dropdown-container w-100"><button class="btn w-100 text-left dropdown-toggle collection-name" type=button id=collectionDropdwnBtn data-toggle=dropdown aria-haspopup=true aria-label="Collection Dropdown" aria-expanded=false>
<span class=label></span>
<span class="float-right icon-down pl-2 fa fa-angle-down"></span></button><div class="dropdown-menu w-100" id=collectionMenu aria-labelledby=collectionDropdwnBtn></div></div><div id=tree class=mt-2></div><div class="w-100 px-2 toc-product-container"><a class="mr-3 my-2 position-relative toc-product-link"><span class=toc-product-name></span>
<span class=localized-page-name>Product Documentation</span></a></div><ul class=rm-default-ul-styles></ul></div></div></div><div class="rhs rhs-container col-md-8 col-lg-7" style=display:block><div class=rhs-top><div class="rhs-top-container-top d-flex flex-row justify-content-between"><h1 class=primary-header id=deploy-tanzu-for-kubernetes-operations-on-microsoft-azure>Deploy Tanzu for Kubernetes Operations on Microsoft Azure</h1></div><div class="rhs-top-container-middle d-flex flex-row justify-content-between"></div><div class=rhs-top-container-bottom><div class=last-updated-container><div class=calendar-icon><svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path class="clr-i-outline clr-i-outline-path-1" d="M32.25 6H29V8h3V30H4V8H7V6H3.75A1.78 1.78.0 002 7.81V30.19A1.78 1.78.0 003.75 32h28.5A1.78 1.78.0 0034 30.19V7.81A1.78 1.78.0 0032.25 6z"/><rect class="clr-i-outline clr-i-outline-path-2" x="8" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-3" x="14" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-4" x="20" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-5" x="26" y="14" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-6" x="8" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-7" x="14" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-8" x="20" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-9" x="26" y="19" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-10" x="8" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-11" x="14" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-12" x="20" y="24" width="2" height="2"/><rect class="clr-i-outline clr-i-outline-path-13" x="26" y="24" width="2" height="2"/><path class="clr-i-outline clr-i-outline-path-14" d="M10 10a1 1 0 001-1V3A1 1 0 009 3V9a1 1 0 001 1z"/><path class="clr-i-outline clr-i-outline-path-15" d="M26 10a1 1 0 001-1V3a1 1 0 00-2 0V9a1 1 0 001 1z"/><rect class="clr-i-outline clr-i-outline-path-16" x="13" y="6" width="10" height="2"/><rect x="0" y="0" width="36" height="36" fill-opacity="0"/></svg></div><span class=last-updated-label data-i18n-updated-on>Updated on</span>
&nbsp;
<span class=last-updated-date-ph>9/22/22</span></div></div></div><div class="rhs-center article-wrapper" id=content-div-id><h1 id=deploy-tanzu-for-kubernetes-operations-on-microsoft-azure>Deploy Tanzu for Kubernetes Operations on Microsoft Azure</h1><p>VMware Tanzu simplifies the operations of Kubernetes for multi-cloud deployments by centralizing management and governance for clusters and teams across on-premises, public clouds, and the edge. It delivers an open source aligned Kubernetes distribution with consistent operations and management to support infrastructure and app modernization.</p><p>This document provides a step-by-step guide for how to install and deploy Tanzu for Kubernetes operations on Microsoft Azure.</p><p>The scope of this document is limited to providing the deployment steps based on the following reference design. The reference design represents one of the two production-level reference designs described in <a href=../reference-designs/tko-on-azure.md>VMware Tanzu for Kubernetes Operations on Azure Reference Design</a>.</p><p><img src=/img/deployment-guides/tko-on-azure/image005.png alt="TKG on Azure (Single VNet)"></p><p>This design shows both the Tanzu Kubernetes Grid management cluster and workload clusters in the same virtual network along with the bootstrap machine. However, each cluster is placed in its own subnet. In addition, the control plane and worker nodes of each cluster are also separated by a subnet.</p><ol><li><p>The reference design shows the deployment of only the base components within Tanzu Kubernetes Grid.</p></li><li><p>The reference design fits in with any production-level design that a customer may have in place, such as a Hub and Spoke, Global WAN Peering, or just a simple DMZ based implementation.</p></li><li><p>This guide does not make any assumptions about your chosen tooling for security or DevOps, other than what is available with a default Azure subscription.</p></li></ol><p><strong>Note:</strong> You can use this guide to deploy additional workload clusters and workload clusters of a different size. However, you&rsquo;ll need to make additional configuration changes. You can make these configuration changes after you have gone through the deployment steps provided in this document.</p><h2 id=prerequisites>Prerequisites</h2><p>Ensure that you have:</p><ul><li>Read <a href=../reference-designs/tko-on-azure.md>VMware Tanzu for Kubernetes Operations on Azure Reference Design</a>.</li><li>A Microsoft Azure subscription.</li><li>Owner-level access to the subscription.</li><li>To deploy the ARM template in Microsoft Azure, you&rsquo;ll need:<ul><li>Contributor role in Microsoft Azure.</li><li>Resource group in Microsoft Azure.</li></ul></li></ul><ul><li>An SSH key and the Base 64 encoded value of the public key. You will configure the Base 64 encoded value for the AZURE_SSH_PUBLIC_KEY_B64 parameter of the configuration file for deploying Tanzu Kubernetes Grid. How you generate the SSH key and how you encode the entire public key is up to you. However, you will need to encode the public key before storing it in the Tanzu Kubernetes Grid deployment configuration file.</li></ul><ul><li>Access to Customer Connect and the available downloads for Tanzu Kubernetes Grid. To verify that you have access, go to <a href="https://customerconnect.vmware.com/en/downloads/details?downloadGroup=TKG-154&productId=988&rPId=73652">VMware Tanzu Kubernetes Grid Download Product</a>.</li></ul><h2 id=overview-of-the-deployment-steps>Overview of the Deployment steps</h2><ol><li><a href=#azure-environment>Set up your Microsoft Azure environment</a></li><li><a href=#set-up-bootstrap>Set up Bootstrap VM</a></li><li><a href=#deploy-TKG>Deploy Tanzu Kubernetes Grid</a></li><li><a href=#config-saas>Configure SaaS Services</a></li><li><a href=#deploy-user-managed-packages>(Optional) Deploy Tanzu Kubernetes Grid Packages</a></li></ol><h2 id=a-idazure-environment-a-set-up-your-microsoft-azure-environment>Set up your Microsoft Azure Environment</h2><p>Before deploying Tanzu for Kubernetes operations and the actual Kubernetes clusters, ensure that your Azure environment is set up as described in this section.</p><h3 id=azure-arm-template>Azure ARM Template</h3><p>The deployment detailed in this document uses the following resources:</p><ul><li><a href=./resources/tko-on-azure/azure-deploy.json>ARM Template</a></li><li><a href=./resources/tko-on-azure/azure-deploy-parameters.json>Parameters</a></li></ul><p>The ARM template contains parameters that you can populate or customize so that your Azure environment uses your naming standards and networking requirements.</p><p>The ARM template deploys the following items:</p><ul><li>Virtual Network</li><li>5 Subnets<ul><li>Bootstrap</li><li>Management Cluster Control Plane (API Servers)</li><li>Management Cluster Worker Nodes</li><li>Workload Cluster Control Plane (API Servers)</li><li>Workload Cluster Worker Nodes</li></ul></li><li>Network Security Group for Bootstrap Machine NIC</li><li>Network Security Groups for each of the Cluster Subnets</li><li>Public IP Address attached to Bootstrap Machine</li><li>Virtual Machine for Bootstrap (Ubuntu 20.0.4)</li></ul><p>In addition, the ARM template,</p><ul><li>Uses the Region where the Resource Group is located to specify where the resources should be deployed.</li><li>Contains security rules for each of the Network Security Groups attached to the Control Plane clusters. These rules allow for SSH and secure kubectl access from the public Internet. Access from the public Internet makes troubleshooting easier while you deploy your management and workload clusters. You can remove these rules after you complete your deployment.</li></ul><h3 id=quotas>Quotas</h3><p>To successfully deploy Tanzu Kubernetes Grid to Azure, ensure that the quotas are sufficient to support both the management cluster and workload cluster deployments. Otherwise, the deployments will fail.</p><p>Review the quotas for the following resources, which are included in the ARM template, and increase their values as needed. Increase the quotas for every region to which you plan to deploy Tanzu Kubernetes Grid.</p><ul><li>Total Regional vCPUs</li><li>Family vCPUs based on your chosen virtual machine family (D, E, F, etc.)</li><li>Static Public IP Addresses</li><li>Public IP Addresses - Standard</li></ul><p>Based on the recommended minimum virtual machine size of D2s_v3, the following minimum quotas are required per cluster:</p><ul><li>Total Regional vCPUs = 24</li><li>Family vCPUs for D Family = 24</li><li>Static Public IP Addresses = 6</li><li>Public IP Addresses - Standard = 6</li></ul><p>Ensure that you increase the quotas if you make changes to the basic configuration of the clusters.</p><h3 id=arm-template-deployment>ARM Template Deployment</h3><h4 id=deploy-arm-template>Deploy ARM Template</h4><p>There are multiple methods to deploy an ARM template on Azure. If you are experienced with Azure, you can deploy the ARM template in a method that is comfortable to you.</p><p>Otherwise, you can use the example Azure CLI commands locally or in Azure Cloud Shell. If you prefer to use Azure PowerShell, use the example command for Azure PowerShell.</p><p>Ensure that you have the following to deploy the ARM template in Microsoft Azure:</p><ul><li>Contributor role in Microsoft Azure.</li><li>Resource group in Microsoft Azure.</li></ul><h4 id=azure-cli>Azure CLI</h4><p>Run the following example Azure CLI command locally or in Azure Cloud Shell to deploy the ARM template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az deployment create –template-file azure-deploy.json –parameters azure-deploy-parameters.json –resource-group &lt;Resource Group Name&gt;
</span></span></code></pre></div><h4 id=azure-powershell>Azure PowerShell</h4><p>Alternatively, run the following example command in Azure PowerShell to deploy the ARM template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>New-AzResourceGroupDeployment -ResourceGroupName &lt;Resource Group Name&gt; -TemplateFile azure-deploy.json -TemplateParameterFile azure-deploy-parameters.json
</span></span></code></pre></div><h4 id=azure-portal>Azure Portal</h4><p>If you prefer to use the Azure Portal, do the following to process an ARM template directly on the Azure Portal.</p><ol><li><p>Search and click <strong>Deploy a Custom Template > Build your own template in the editor</strong>.
<img src=/img/deployment-guides/tko-on-azure/CustomDeployment.png alt="Custom Deployment of ARM template"></p></li><li><p>Click <strong>Load file</strong> to upload the ARM template, <code>azuredeploy.json</code>.
<img src=/img/deployment-guides/tko-on-azure/LoadFile.png alt="Load file to upload ARM template"></p></li><li><p>Fill in the parameter values so that the values are specific to your deployment.
<img src=/img/deployment-guides/tko-on-azure/Parameters.png alt="Provide parameter values for custom deployment"></p></li></ol><h3 id=azure-service-principalapplication-registration-creation>Azure Service Principal/Application Registration Creation</h3><p>The Tanzu CLI requires access to an Azure Service Principal (SP) or Application Registration to programmatically configure the Tanzu cluster’s infrastructure during deployment and during auto-scale events.</p><p>VMware recommends that you create the SP on the Azure Portal. However, if you prefer to use either the Azure CLI or Azure PowerShell, see the following Microsoft product documentation:</p><ul><li><a href=https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli>Azure CLI</a></li><li><a href="https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps?view=azps-6.6.0">Azure PowerShell</a></li></ul><p><strong>Important:</strong> To create an Azure Service Principal or Application Registration, you must be an <strong>Administrator</strong> in your Azure Active Directory tenant. Alternatively, all Users must have <strong>App Registrations</strong> set to <strong>Yes</strong>, which allows all Users to create an Azure Service Principal.</p><p>Do the following on the Azure portal to create an Azure Service Principal:</p><ol><li><p>Go to <strong>Azure Active Directory > Application Registrations</strong>.
<img src=/img/deployment-guides/tko-on-azure/AADAppReg.png alt="Azure Active Directory Application Registrations"></p></li><li><p>Click <strong>New App Registration</strong>.
<img src=/img/deployment-guides/tko-on-azure/NewReg.png alt="New Application Registration"></p></li><li><p>Enter the following:</p><ul><li><strong>Name</strong>: Enter a name that reflects what the App Registration is being used for.
Example: <code>tanzucli</code></li><li><strong>URL</strong>: Enter any URL.
In this deployment, the App Registration is used for programmatic purposes only. In such cases, the URL can be anything. However, the field is required.</li><li><strong>Supported Account Type</strong>: (Optional) By default, <strong>Accounts in this organizational directory only (Default Directory only - Single tenant)</strong> is selected.
In the default case, the new App Registration is used for a Single Azure Active Directory tenant and for development clusters. Depending on the size of the organization that Tanzu is deployed in, the App Registration may need to be available across one-to-many Azure Active Directory tenants. For such cases, select the appropriate multi-tenant option.</li></ul><p><img src=/img/deployment-guides/tko-on-azure/AppRegFields.png alt="Fill Out Application Registration Fields"></p><p>After the Application Registration is created, an <strong>Overview</strong> page appears.</p></li><li><p>Copy the values for the <strong>Application client ID</strong> and <strong>Directory (tenant) ID</strong> from the <strong>Overview</strong> page. You will need the IDs for running the Tanzu CLI.</p><p><img src=/img/deployment-guides/tko-on-azure/AppRegInfo.png alt="Application Registration Overview"></p></li><li><p>Add a Key to the Application Registration.</p><p>You will use the key for programmatic authentication and execution.</p><ol><li><p>Click <strong>Certificates & secrets > Client secrets > New client secret</strong>.
<img src=/img/deployment-guides/tko-on-azure/AppRegSecret.png alt="Add Application Registration Key"></p></li><li><p>Choose the expiration date.</p></li><li><p>Store the randomly generated key so that it can be used later.</p></li></ol></li><li><p>Assign <strong>VM Contributor</strong> and <strong>Network Contributor</strong> roles to the Azure SP.</p><p>The roles provide the minimum level of permissions required for the Tanzu CLI to function properly within Azure.</p><p>Assign the roles through the Subscription scope. Depending on your security boundaries, you can also assign it at the Resource Group scope.</p><p><strong>Important:</strong> To assign a role to the SP, you must have either the <strong>Owner</strong> role or <strong>User Access Administration</strong> role within the scope of the Azure subscription.</p><ol><li><p>Find your specific Subscription on the Azure Portal and go to <strong>Access Control (IAM) > Roles</strong>.</p><p><img src=/img/deployment-guides/tko-on-azure/SubscriptionIAM.png alt="Subscription Scoped Identity Access Management(IAM)"></p></li><li><p>Click <strong>Add role assignment</strong>.</p></li><li><p>In the <strong>Add role assignment</strong> page, select <strong>User, group, or service principal</strong>.
<img src=/img/deployment-guides/tko-on-azure/RoleAssign.png alt="Assign a Role to Application Registration"></p></li><li><p>For <strong>Select Members</strong>, search for the new SP name you created.</p></li></ol></li><li><p>Make a note of the following information. You will need the information to create the configuration files to set up the Bootstrap machine and Tanzu CLI.</p><ul><li>Azure Subscription ID</li><li>Azure Active Directory Tenant ID</li><li>Azure Application ID (ServicePrincipal)</li><li>Azure Application Key</li></ul></li></ol><h2 id=a-idset-up-bootstrap-a-set-up-bootstrap-vm>Set Up Bootstrap VM</h2><p>You will use the bootstrap VM to deploy the Tanzu Kubernetes Grid management and workload clusters. Create the bootstrap VM after you have set up your Microsoft Azure environment.</p><p>You will set up the bootstrap VM with the following:</p><ul><li>Authentication and access to VMware Customer Connect
You will download the required Tanzu components from VMware Customer Connect.</li><li>Azure Tenant, subscription, and client IDs
The IDs are for the Azure subscription on which you created resources using the ARM template.</li><li>Docker</li><li>Azure CLI</li><li>Tanzu CLI</li><li>Tanzu Kubectl</li></ul><p>To set up the bootstrap VM:</p><ol><li>Verify that the VM is up and running.</li><li>Connect to the VM through a standard SSH connection.</li><li>Run the following Shell commands to set up the bootstrap VM.
Replace the variables with the VMware account information needed to access VMware Customer Connect and Azure IDs for the Azure subscription on which you created resources using the ARM template and Application Registration/Service Principal.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span>export VMWUSER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;CUSTOMER_CONNECT_USERID&gt;&#34;</span>
</span></span><span style=display:flex><span>export VMWPASS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;CUSTOMER_CONNECT_PWD&gt;&#34;</span>
</span></span><span style=display:flex><span>export AZURETENANTID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;AAD Tenant ID&gt;&#34;</span>
</span></span><span style=display:flex><span>export AZURESUBSCRIPTION <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;Subscription GUID&gt;&#34;</span>
</span></span><span style=display:flex><span>export AZURECLIENTID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;Service Principal ID&gt;&#34;</span>
</span></span><span style=display:flex><span>export AZURECLIENTSECRET <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;Service Principal Secret&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get upgrade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Docker Install &amp; Verify</span>
</span></span><span style=display:flex><span>sudo apt-get install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-transport-https <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gnupg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    lsb-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;deb [arch=</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture<span style=color:#66d9ef>)</span><span style=color:#e6db74> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo groupadd docker
</span></span><span style=display:flex><span>sudo usermod -aG docker $USER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional Verification</span>
</span></span><span style=display:flex><span><span style=color:#75715e># docker run hello-world</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Downloading and Installing Tanzu CLI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git clone https://github.com/z4ce/vmw-cli
</span></span><span style=display:flex><span>cd vmw-cli
</span></span><span style=display:flex><span>curl -o tmc <span style=color:#e6db74>&#39;https://tmc-cli.s3-us-west-2.amazonaws.com/tmc/0.4.3-fcb03104/linux/x64/tmc&#39;</span>
</span></span><span style=display:flex><span>./vmw-cli ls
</span></span><span style=display:flex><span>./vmw-cli ls vmware_tanzu_kubernetes_grid
</span></span><span style=display:flex><span>./vmw-cli cp tanzu-cli-bundle-linux-amd64.tar.gz
</span></span><span style=display:flex><span>./vmw-cli cp <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>./vmw-cli ls vmware_tanzu_kubernetes_grid | grep kubectl-linux | cut -d <span style=color:#e6db74>&#39; &#39;</span> -f1<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>curl -o yq -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo install yq /usr/local/bin
</span></span><span style=display:flex><span>sudo install tmc /usr/local/bin/tmc
</span></span><span style=display:flex><span>yes | tar --overwrite -xzvf tanzu-cli-bundle-linux-amd64.tar.gz
</span></span><span style=display:flex><span>yes | gunzip kubectl-*.gz
</span></span><span style=display:flex><span>sudo install kubectl-linux-* /usr/local/bin/kubectl
</span></span><span style=display:flex><span>cd cli/
</span></span><span style=display:flex><span>sudo install core/*/tanzu-core-linux_amd64 /usr/local/bin/tanzu
</span></span><span style=display:flex><span>yes | gunzip *.gz
</span></span><span style=display:flex><span>sudo install imgpkg-linux-amd64-* /usr/local/bin/imgpkg
</span></span><span style=display:flex><span>sudo install kapp-linux-amd64-* /usr/local/bin/kapp
</span></span><span style=display:flex><span>sudo install kbld-linux-amd64-* /usr/local/bin/kbld
</span></span><span style=display:flex><span>sudo install vendir-linux-amd64-* /usr/local/bin/vendir
</span></span><span style=display:flex><span>sudo install ytt-linux-amd64-* /usr/local/bin/ytt
</span></span><span style=display:flex><span>cd ..
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tanzu plugin sync
</span></span><span style=display:flex><span>tanzu config init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Azure CLI Install and VM Acceptance</span>
</span></span><span style=display:flex><span>curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>az login --service-principal --username $AZURECLIENTID --password $AZURECLIENTSECRET --tenant $AZURETENANTID
</span></span><span style=display:flex><span>az vm image terms accept --publisher vmware-inc --offer tkg-capi --plan k8s-1dot21dot2-ubuntu-2004 --subscription $AZURESUBSCRIPTION
</span></span></code></pre></div><p><strong>Note:</strong> Because of permission issues, you will have to log out and log in to the bootstrap VM after installing Docker and before you download and install the Tanzu components.</p><p>If you prefer not to copy paste code, you can use the following sample script files:</p><ul><li><a href=./resources/tko-on-azure/bootstrapsetup.sh><code>bootstrapsetup.sh</code></a></li><li><a href=./resources/tko-on-azure/bootstraptanzu.sh><code>bootstraptanzu.sh</code></a></li></ul><h2 id=a-iddeploy-tkg-a-deploy-tanzu-kubernetes-grid>Deploy Tanzu Kubernetes Grid</h2><p>Deploy Tanzu Kubernetes Grid after you set up your Azure environment and bootstrap VM.
You will use Tanzu CLI to deploy a management cluster and workload cluster.</p><ol><li><p>Create a YAML file that contains the required configuration details.</p><p>The <a href=./resources/tko-on-azure/ex-config.yaml>ex-config.yaml</a> sample YAML file contains the minimum configuration needed to deploy a management cluster and workload clusters. The configuration contains the default values used in the ARM template. Change the values in the YAML as needed for your deployment. For example, replace the values for the Azure IDs, Application Registration/Service Principal, cluster name, and the Base 64 encoded value of the public key.</p></li><li><p>Run the following commands from your bootstrap VM to create the management and workload clusters.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tanzu management-cluster create --file config.yaml -v 0-9
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tanzu cluster create –file config.yaml -v 0-9
</span></span></code></pre></div></li></ol><p>For additional product documentation on how to create the YAML configuration file and what each value corresponds to in Azure, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-config-azure.html>Management Cluster Configuration for Microsoft Azure</a>.</p><h2 id=a-idconfig-saas-a-configure-saas-services>Configure SaaS Services</h2><p>The following VMware SaaS services provide additional Kubernetes lifecycle management, observability, and service mesh features.</p><ul><li>Tanzu Mission Control (TMC)</li><li>Tanzu Observability (TO)</li><li>Tanzu Service Mesh (TSM)</li></ul><p>For configuration information, see <a href=./tko-saas-services.md>Configure SaaS Services</a>.</p><h2 id=a-iddeploy-user-managed-packages-optional-deploy-tanzu-kubernetes-grid-packages>(Optional) Deploy Tanzu Kubernetes Grid Packages</h2><p>A package in Tanzu Kubernetes Grid is a collection of related software that supports or extends the core functionality of the Kubernetes cluster in which the package is installed.</p><p>These packages are available for deployment in each workload cluster that you deploy, but they are not automatically installed and working as pods.</p><p>Tanzu Kubernetes Grid includes two types of packages, auto-managed packages and CLI-managed packages.</p><h3 id=auto-managed-packages>Auto-Managed Packages</h3><p>Tanzu Kubernetes Grid automatically installs the auto-managed packages during cluster creation. For more information about auto-managed packages, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-core-index.html>Auto-Managed Packages</a>.</p><h3 id=cli-managed-packages>CLI-Managed Packages</h3><p>A CLI-managed package is an optional component of a Kubernetes cluster that you can install and manage with the Tanzu CLI. These packages are installed after cluster creation. CLI-managed packages are grouped into package repositories in the Tanzu CLI. If a package repository that contains CLI-managed packages is available in the target cluster, you can use the Tanzu CLI to install and manage any of the packages from that repository.</p><p>Using the Tanzu CLI, you can install CLI-managed packages from the built-in <code>tanzu-standard</code> package repository or from package repositories that you add to your target cluster. From the <code>tanzu-standard</code> package repository, you can install the Cert Manager, Contour, External DNS, Fluent Bit, Grafana, Harbor, Multus CNI, and Prometheus packages. For more information about CLI-managed packages, see <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-user-managed-index.html>CLI-Managed Packages</a>.</p><p>The following provide more information on installing VMware recommended CLI-managed packages:</p><ul><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-cert-manager.html>Install Cert Manager</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-ingress-contour.html>Implement Ingress Control with Contour</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-logging-fluentbit.html>Implement Log Forwarding with Fluent Bit</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-monitoring.html>Implement Monitoring with Prometheus and Grafana</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-cni-multus.html>Implement Multiple Pod Network Interfaces with Multus</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-external-dns.html>Implement Service Discovery with ExternalDNS</a></p></li><li><p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/vmware-tanzu-kubernetes-grid-15/GUID-packages-harbor-registry.html>Deploy Harbor Registry as a Shared Service</a></p></li></ul><p>If your deployment requires Harbor to take on a heavy load and store large images in the registry, you can install Harbor into a separate workload cluster.</p></div></div><div class="loader-container-toc col-lg-2 w-100" style=display:none><span class=spinner></span></div><div class="rhs-right-container d-none d-lg-block col-lg-2"><div class=rhs-right-panel><div class="rhs-right-panel-header d-flex justify-content-between"><div class=rhs-right-panel-title>In this article</div></div><div id=right-toc-div-id class="onpage-toc-container d-flex flex-column"><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#overview-of-the-deployment-steps>Overview of the Deployment steps</a></li><li><a href=#a-idazure-environment-a-set-up-your-microsoft-azure-environment>Set up your Microsoft Azure Environment</a><ul><li><a href=#azure-arm-template>Azure ARM Template</a></li><li><a href=#quotas>Quotas</a></li><li><a href=#arm-template-deployment>ARM Template Deployment</a></li><li><a href=#azure-service-principalapplication-registration-creation>Azure Service Principal/Application Registration Creation</a></li></ul></li><li><a href=#a-idset-up-bootstrap-a-set-up-bootstrap-vm>Set Up Bootstrap VM</a></li><li><a href=#a-iddeploy-tkg-a-deploy-tanzu-kubernetes-grid>Deploy Tanzu Kubernetes Grid</a></li><li><a href=#a-idconfig-saas-a-configure-saas-services>Configure SaaS Services</a></li><li><a href=#a-iddeploy-user-managed-packages-optional-deploy-tanzu-kubernetes-grid-packages>(Optional) Deploy Tanzu Kubernetes Grid Packages</a><ul><li><a href=#auto-managed-packages>Auto-Managed Packages</a></li><li><a href=#cli-managed-packages>CLI-Managed Packages</a></li></ul></li></ul></nav></div></div></div></section></div><footer class=tech-pub-footer><div id=page-footer><section class="footer-component footer-container"><div class=personalization_div_1 style=min-height:1px></div><div class=personalization_div_2 style=min-height:1px></div><div class=container><div class=content><div class=row><div class="col-lg-12 col-md-12"><footer class=footer><div class=row><div class="col-lg-2 col-md-12 mb-40 mt-3"><a class=footer-vmware-logo href=https://www-lt.vmware.com/ name="nav_footer : VMware Logo"><picture class=float-lg-left><source media=(max-width:800px) srcset=https://www-lt.vmware.com/content/dam/digitalmarketing/vmware/vm-logo-big.png.imgo.jpeg><img loading=lazy class=vmware-logo src=/validated-solutions/img/vm-logo-big.png alt=VMware title=VMware></picture></a></div></div></footer></div></div></div></div></section></div></footer><script src=/validated-solutions/js/pageStore.js></script>
<script src=/validated-solutions/js/main.js></script></body></html>